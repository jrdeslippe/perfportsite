
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../../favicon.ico">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>OpenMP - Performance Portability</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="green" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Performance Portability" class="md-logo md-header-nav__button">
            <img src="../../../images/oos.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Approaches
                </span>
              
                <span class="md-header-nav__parent">
                  Directives
                </span>
              
            
            OpenMP
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../../../images/oos.png">
      </i>
    
    Performance Portability
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Office of Science Facilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Office of Science Facilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/comparison/" title="Comparison" class="md-nav__link">
      Comparison
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Performance Portability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Performance Portability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../definition/" title="Overview and Definition" class="md-nav__link">
      Overview and Definition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Measurements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Measurements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../measurements/" title="Measurement Techniques" class="md-nav__link">
      Measurement Techniques
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../measurements/knl/" title="Collecting Roofline on KNL" class="md-nav__link">
      Collecting Roofline on KNL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../measurements/gpu/" title="Collecting Roofline on GPUs" class="md-nav__link">
      Collecting Roofline on GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3" checked>
    
    <label class="md-nav__link" for="nav-3-3">
      Approaches
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Approaches
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../libraries/" title="Libraries" class="md-nav__link">
      Libraries
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-2" type="checkbox" id="nav-3-3-2" checked>
    
    <label class="md-nav__link" for="nav-3-3-2">
      Directives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-2">
        Directives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../openacc/" title="OpenACC" class="md-nav__link">
      OpenACC
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        OpenMP
      </label>
    
    <a href="./" title="OpenMP" class="md-nav__link md-nav__link--active">
      OpenMP
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#omp-simd" title="omp simd" class="md-nav__link">
    omp simd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omp-target" title="omp target" class="md-nav__link">
    omp target
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#benefits-and-challenges" title="Benefits and Challenges" class="md-nav__link">
    Benefits and Challenges
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benefits" title="Benefits" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenges" title="Challenges" class="md-nav__link">
    Challenges
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiler-support" title="Compiler Support" class="md-nav__link">
    Compiler Support
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-3" type="checkbox" id="nav-3-3-3">
    
    <label class="md-nav__link" for="nav-3-3-3">
      Frameworks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-3">
        Frameworks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../frameworks/kokkos/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../frameworks/raja/" title="RAJA" class="md-nav__link">
      RAJA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../dsl/" title="DSL" class="md-nav__link">
      DSL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Case Studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Case Studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1" type="checkbox" id="nav-3-4-1">
    
    <label class="md-nav__link" for="nav-3-4-1">
      BoxLib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-1">
        BoxLib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/amr/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/amr/parallelism/" title="Parallelism" class="md-nav__link">
      Parallelism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/amr/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/amr/multigrid/" title="Geometric Multigrid" class="md-nav__link">
      Geometric Multigrid
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1-5" type="checkbox" id="nav-3-4-1-5">
    
    <label class="md-nav__link" for="nav-3-4-1-5">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-1-5">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/amr/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/amr/openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/amr/performance_comparison/" title="Performance" class="md-nav__link">
      Performance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-2" type="checkbox" id="nav-3-4-2">
    
    <label class="md-nav__link" for="nav-3-4-2">
      BGW
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-2">
        BGW
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/gw/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/gw/code_structure/" title="Code structure" class="md-nav__link">
      Code structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-2-3" type="checkbox" id="nav-3-4-2-3">
    
    <label class="md-nav__link" for="nav-3-4-2-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-2-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/gw/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/gw/openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/gw/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3">
    
    <label class="md-nav__link" for="nav-3-4-3">
      QCD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        QCD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/qcd/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/qcd/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3-3" type="checkbox" id="nav-3-4-3-3">
    
    <label class="md-nav__link" for="nav-3-4-3-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-3-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/qcd/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/qcd/results_summary/" title="Results" class="md-nav__link">
      Results
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/nek/" title="NekBone" class="md-nav__link">
      NekBone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../case_studies/md/" title="MD" class="md-nav__link">
      MD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../resources/" title="Other Resources" class="md-nav__link">
      Other Resources
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#omp-simd" title="omp simd" class="md-nav__link">
    omp simd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#omp-target" title="omp target" class="md-nav__link">
    omp target
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#benefits-and-challenges" title="Benefits and Challenges" class="md-nav__link">
    Benefits and Challenges
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#benefits" title="Benefits" class="md-nav__link">
    Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenges" title="Challenges" class="md-nav__link">
    Challenges
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiler-support" title="Compiler Support" class="md-nav__link">
    Compiler Support
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="openmp">OpenMP<a class="headerlink" href="#openmp" title="Permanent link">&para;</a></h1>
<p>OpenMP is a specification for a set of compiler directives, library routines,
and environment variables that can be used to specify high-level parallelism in
Fortran and C/C++ programs. The OpenMP API uses the fork-join model of parallel
execution. Multiple threads of execution perform tasks defined implicitly or
explicitly by OpenMP directives. (<em>Text taken from <a href="http://www.openmp.org/about/openmp-faq/">OpenMP
FAQ</a> and <a href="http://www.openmp.org/wp-content/uploads/openmp-4.5.pdf">API
specification</a>.</em>)</p>
<p>Although the directives in early versions of the OpenMP specification focused
on thread-level parallelism, more recent versions (especially 4.0 and 4.5) have
generalized the specification to address more complex types (and multiple
types) of parallelism, reflecting the increasing degree of on-node parallelism
in HPC architectures. In particular, OpenMP 4.0 introduced the <code>simd</code> and
<code>target</code> constructs. We discuss each of these in detail below.</p>
<h2 id="omp-simd"><code>omp simd</code><a class="headerlink" href="#omp-simd" title="Permanent link">&para;</a></h2>
<p>Decorating a loop with the <code>simd</code> construct informs the compiler that the loop
iterations are independent and can be executed with SIMD instructions (e.g.,
AVX-512 on Intel Xeon Phi), e.g.,</p>
<div class="codehilite"><pre><span></span><span class="c">!$omp simd</span>
<span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">array_size</span>
  <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="k">end do</span>
<span class="c">!$omp end simd</span>
</pre></div>

<p>Example output from a compiler optimization report for this loop is as follows:
<div class="codehilite"><pre><span></span>LOOP BEGIN at main.f90(9,3)
   remark #15388: vectorization support: reference A(i) has aligned access   [ main.f90(10,5) ]
   remark #15388: vectorization support: reference B(i) has aligned access   [ main.f90(10,12) ]
   remark #15388: vectorization support: reference C(i) has aligned access   [ main.f90(10,19) ]
   remark #15305: vectorization support: vector length 16
   remark #15399: vectorization support: unroll factor set to 4
   remark #15301: OpenMP SIMD LOOP WAS VECTORIZED
   remark #15448: unmasked aligned unit stride loads: 2
   remark #15449: unmasked aligned unit stride stores: 1
   remark #15475: --- begin vector cost summary ---
   remark #15476: scalar cost: 6
   remark #15477: vector cost: 0.310
   remark #15478: estimated potential speedup: 19.200
   remark #15488: --- end vector cost summary ---
LOOP END
</pre></div></p>
<p>The <code>simd</code> construct can be combined with the traditional <code>parallel for</code> (or
<code>parallel do</code> in Fortran) constructs in order to execute the loop with both
multi-threading and with SIMD instructions, e.g.,</p>
<div class="codehilite"><pre><span></span><span class="c">!$omp parallel do simd</span>
<span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">array_size</span>
  <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="k">end do</span>
<span class="c">!$omp end parallel do simd</span>
</pre></div>

<p>The optimization report for the above snippet is as follows:</p>
<div class="codehilite"><pre><span></span>Begin optimization report for: MAIN

    Report from: OpenMP optimizations [openmp]

main.f90(8:9-8:9):OMP:MAIN__:  OpenMP DEFINED LOOP WAS PARALLELIZED

    Report from: Vector optimizations [vec]

LOOP BEGIN at main.f90(8,9)
   remark #15388: vectorization support: reference a(i) has aligned access   [ main.f90(10,5) ]
   remark #15389: vectorization support: reference b(i) has unaligned access   [ main.f90(10,12) ]
   remark #15389: vectorization support: reference c(i) has unaligned access   [ main.f90(10,19) ]
   remark #15381: vectorization support: unaligned access used inside loop body
   remark #15305: vectorization support: vector length 32
   remark #15399: vectorization support: unroll factor set to 2
   remark #15309: vectorization support: normalized vectorization overhead 0.667
   remark #15301: OpenMP SIMD LOOP WAS VECTORIZED
   remark #15449: unmasked aligned unit stride stores: 1
   remark #15450: unmasked unaligned unit stride loads: 2
   remark #15475: --- begin vector cost summary ---
   remark #15476: scalar cost: 6
   remark #15477: vector cost: 0.370
   remark #15478: estimated potential speedup: 15.670
   remark #15488: --- end vector cost summary ---
LOOP END
</pre></div>

<p>It is important to note that compilers generally analyze loops (even those
undecorated with <code>omp simd</code>) to determine if they can be executed with SIMD
instructions; applying this OpenMP construct usually allows the compiler to
skip its loop dependency checks and immediately generate a SIMD version of the
loop. Consequently, improper use of <code>omp simd</code>, e.g., on a loop which indeed
carries dependencies between iterations, can generate wrong code. This
construct shifts the burden of correctness from the compiler to the user.</p>
<p>For example, consider the following loop, with a write-after-read dependency:
<div class="codehilite"><pre><span></span><span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">array_size</span>
  <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end do</span>
</pre></div></p>
<p>Attempting to compile it without the <code>simd</code> construct yields the following
optimization report:</p>
<div class="codehilite"><pre><span></span>LOOP BEGIN at main.f90(8,3)
   remark #15344: loop was not vectorized: vector dependence prevents vectorization
   remark #15346: vector dependence: assumed FLOW dependence between a(i) (9:5) and a(i-1) (9:5)
LOOP END
</pre></div>

<p>The compiler has determined that the loop iterations cannot be executed in
SIMD. However, if we introduce the <code>simd</code> construct, this assures the compiler
(incorrectly) that the loop iterations can be executed in SIMD. Using the
construct results in the following report:</p>
<div class="codehilite"><pre><span></span>LOOP BEGIN at main.f90(9,3)
   remark #15388: vectorization support: reference A(i) has aligned access   [ main.f90(10,5) ]
   remark #15388: vectorization support: reference B(i) has aligned access   [ main.f90(10,12) ]
   remark #15389: vectorization support: reference A(i-1) has unaligned access   [ main.f90(10,19) ]
   remark #15381: vectorization support: unaligned access used inside loop body
   remark #15305: vectorization support: vector length 32
   remark #15399: vectorization support: unroll factor set to 2
   remark #15301: OpenMP SIMD LOOP WAS VECTORIZED
   remark #15448: unmasked aligned unit stride loads: 1
   remark #15449: unmasked aligned unit stride stores: 1
   remark #15450: unmasked unaligned unit stride loads: 1
   remark #15475: --- begin vector cost summary ---
   remark #15476: scalar cost: 6
   remark #15477: vector cost: 0.340
   remark #15478: estimated potential speedup: 17.450
   remark #15488: --- end vector cost summary ---
LOOP END
</pre></div>

<p>This example illustrates the prescriptive nature of OpenMP directives; they
allow the user to instruct the compiler precisely how on-node parallelism
should be expressed, even if the compiler's own correctness-checking heuristics
indicate that the desired approach will generate incorrect results.</p>
<h2 id="omp-target">omp target<a class="headerlink" href="#omp-target" title="Permanent link">&para;</a></h2>
<p>The OpenMP <code>target</code> device construct maps variables to a device data
environment and executes the construct on that device. A region enclosed with
the <code>target</code> construct is assigned a target task to be executed on the device.
This construct supports several additional keywords which provide the user with
control of which data is moved to and from the device. Specifically, data
movement is achieved via the <code>map</code> keyword, which accepts a list of variables
to be copied between the host and device.</p>
<p>Consider the following snippet:
<div class="codehilite"><pre><span></span><span class="c">!$omp target map(to:b,c) map(from:a)</span>
<span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">array_size</span>
  <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="k">end do</span>
<span class="c">!$omp end target</span>
</pre></div></p>
<p>The compiler report from the following code offloaded to an Intel Xeon Phi
coprocessor is as follows:</p>
<div class="codehilite"><pre><span></span>    Report from: Offload optimizations [offload]

OFFLOAD:main(8,9):  Offload to target MIC 1
 Evaluate length/align/alloc_if/free_if/alloc/into expressions
   Modifier expression assigned to __offload_free_if.19
   Modifier expression assigned to __offload_alloc_if.20
   Modifier expression assigned to __offload_free_if.21
   Modifier expression assigned to __offload_alloc_if.22
   Modifier expression assigned to __offload_free_if.23
   Modifier expression assigned to __offload_alloc_if.24
 Data sent from host to target
       i, scalar size 4 bytes
       __offload_stack_ptr_main_$C_V$5.0, pointer to array reference expression with base
       __offload_stack_ptr_main_$B_V$6.0, pointer to array reference expression with base
 Data received by host from target
       __offload_stack_ptr_MAIN__.34, pointer to array reference expression with base 

LOOP BEGIN at main.f90(12,3)
   remark #15388: vectorization support: reference A(i) has aligned access   [ main.f90(13,5) ]
   remark #15389: vectorization support: reference B(i) has unaligned access   [ main.f90(13,12) ]
   remark #15389: vectorization support: reference C(i) has unaligned access   [ main.f90(13,19) ]
   remark #15381: vectorization support: unaligned access used inside loop body
   remark #15305: vectorization support: vector length 32
   remark #15399: vectorization support: unroll factor set to 2
   remark #15309: vectorization support: normalized vectorization overhead 0.654
   remark #15300: LOOP WAS VECTORIZED
   remark #15449: unmasked aligned unit stride stores: 1
   remark #15450: unmasked unaligned unit stride loads: 2
   remark #15475: --- begin vector cost summary ---
   remark #15476: scalar cost: 7
   remark #15477: vector cost: 0.400
   remark #15478: estimated potential speedup: 17.180
   remark #15488: --- end vector cost summary ---
   remark #25015: Estimate of max trip count of loop=1024
LOOP END
</pre></div>

<p>The same code offloaded to an NVIDIA Tesla GPU shows the following compiler
report (from a different compiler than the ones shown above):</p>
<div class="codehilite"><pre><span></span>    1.           program main
    2.             implicit none
    3.
    4.             integer, parameter :: array_size = 65536
    5.             real, dimension(array_size) :: a, b, c
    6.             integer :: i
    7.
    8.    fA--&lt;&gt;   b(:) = 1.0
    9.    f---&lt;&gt;   c(:) = 2.0
   10.
   11.  + G----&lt;   !$omp target map(to:b,c) map(from:a)
   12.    G g--&lt;   do i = 1, array_size
   13.    G g        a(i) = b(i) * c(i)
   14.    G g--&gt;   end do
   15.    G----&gt;   !$omp end target
   16.
   17.             print *, a(1)
   18.
   19.           end program main

ftn-6230 ftn: VECTOR MAIN, File = main.f90, Line = 8
  A loop starting at line 8 was replaced with multiple library calls.

ftn-6004 ftn: SCALAR MAIN, File = main.f90, Line = 9
  A loop starting at line 9 was fused with the loop starting at line 8.

ftn-6405 ftn: ACCEL MAIN, File = main.f90, Line = 11
  A region starting at line 11 and ending at line 15 was placed on the accelerator.

ftn-6418 ftn: ACCEL MAIN, File = main.f90, Line = 11
  If not already present: allocate memory and copy whole array &quot;c&quot; to accelerator, free at line 15 (acc_copyin).

ftn-6418 ftn: ACCEL MAIN, File = main.f90, Line = 11
  If not already present: allocate memory and copy whole array &quot;b&quot; to accelerator, free at line 15 (acc_copyin).

ftn-6420 ftn: ACCEL MAIN, File = main.f90, Line = 11
  If not already present: allocate memory for whole array &quot;a&quot; on accelerator, copy back at line 15 (acc_copyout).

ftn-6430 ftn: ACCEL MAIN, File = main.f90, Line = 12
  A loop starting at line 12 was partitioned across the 128 threads within a threadblock.
</pre></div>

<p>Note in the last compiler report that OpenMP automatically threads the loop and
partitions the threads into threadblocks of the appropriate size for the device
executing the loop.</p>
<h2 id="benefits-and-challenges">Benefits and Challenges<a class="headerlink" href="#benefits-and-challenges" title="Permanent link">&para;</a></h2>
<h3 id="benefits">Benefits<a class="headerlink" href="#benefits" title="Permanent link">&para;</a></h3>
<ul>
<li>Available for many different languages</li>
<li>Prescriptive control of execution</li>
<li>Allow performance optimization</li>
<li>Controlled by well-defined standards bodies</li>
</ul>
<h3 id="challenges">Challenges<a class="headerlink" href="#challenges" title="Permanent link">&para;</a></h3>
<ul>
<li>Sensitive to compiler support/maturity</li>
<li>Evolving standards</li>
</ul>
<h2 id="compiler-support">Compiler Support<a class="headerlink" href="#compiler-support" title="Permanent link">&para;</a></h2>
<p>The following table summarizes the OpenMP compiler support.</p>
<table>
<thead>
<tr>
<th>Compiler</th>
<th>Language Support</th>
<th>Architecture Support</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>GNU</td>
<td>C/C++ (&gt;6.1), Fortran (&gt;7.2)</td>
<td>Range of CPUs, nvidia GPUs</td>
<td>performance problems on CPU (<a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=80859">bug #80859</a>), compilation problems with <code>enter data</code> and <code>exit data</code> constructs (<a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=81896">bug #81896</a>)</td>
</tr>
<tr>
<td>Intel</td>
<td>C/C++, Fortran (&gt;17.0)</td>
<td>x86-64 CPUs</td>
<td>generated code in target region can be wrong, working on a testcase to demonstrate that problem</td>
</tr>
<tr>
<td>Cray</td>
<td>C/C++, Fortran (&gt;8.5)</td>
<td>x86-64 CPUs, nvidia GPUs</td>
<td>failure at link time when host-offloading is used (bug #189760)</td>
</tr>
<tr>
<td>IBM</td>
<td>C/C++ (&gt;13.1.5), Fortran (&gt;15.1.5)</td>
<td>Power CPUs, nvidia GPUs</td>
<td>multiple-definitions link error when <code>target</code> region is contained in header file which is included by multiple compilation units (bug #147007)</td>
</tr>
</tbody>
</table>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../openacc/" title="OpenACC" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                OpenACC
              </span>
            </div>
          </a>
        
        
          <a href="../../frameworks/kokkos/" title="Kokkos" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Kokkos
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>