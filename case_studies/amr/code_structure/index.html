
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>Code Structure - Performance Portability</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="green" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Performance Portability" class="md-logo md-header-nav__button">
            <img src="../../../images/oos.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Case Studies
                </span>
              
                <span class="md-header-nav__parent">
                  BoxLib
                </span>
              
            
            Code Structure
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../../../images/oos.png">
      </i>
    
    Performance Portability
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Office of Science Facilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Office of Science Facilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/comparison/" title="Comparison" class="md-nav__link">
      Comparison
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Performance Portability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Performance Portability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/definition/" title="Definition" class="md-nav__link">
      Definition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Measurements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Measurements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/" title="Measurement Techniques" class="md-nav__link">
      Measurement Techniques
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/knl/" title="Collecting Roofline on KNL" class="md-nav__link">
      Collecting Roofline on KNL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/gpu/" title="Collecting Roofline on GPUs" class="md-nav__link">
      Collecting Roofline on GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Approaches
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Approaches
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/libraries/" title="Libraries" class="md-nav__link">
      Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-2" type="checkbox" id="nav-3-3-2">
    
    <label class="md-nav__link" for="nav-3-3-2">
      Directives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-2">
        Directives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openacc/" title="OpenACC" class="md-nav__link">
      OpenACC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openmp/" title="OpenMP" class="md-nav__link">
      OpenMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-3" type="checkbox" id="nav-3-3-3">
    
    <label class="md-nav__link" for="nav-3-3-3">
      Frameworks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-3">
        Frameworks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/kokkos/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/raja/" title="RAJA" class="md-nav__link">
      RAJA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/dsl/" title="DSL" class="md-nav__link">
      DSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4" checked>
    
    <label class="md-nav__link" for="nav-3-4">
      Case Studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Case Studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1" type="checkbox" id="nav-3-4-1" checked>
    
    <label class="md-nav__link" for="nav-3-4-1">
      BoxLib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-1">
        BoxLib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../parallelism/" title="Parallelism" class="md-nav__link">
      Parallelism
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
    <a href="./" title="Code Structure" class="md-nav__link md-nav__link--active">
      Code Structure
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multigrid/" title="Geometric Multigrid" class="md-nav__link">
      Geometric Multigrid
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1-5" type="checkbox" id="nav-3-4-1-5">
    
    <label class="md-nav__link" for="nav-3-4-1-5">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-1-5">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/" title="GW Kernels" class="md-nav__link">
      GW Kernels
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3">
    
    <label class="md-nav__link" for="nav-3-4-3">
      QCD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        QCD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3-3" type="checkbox" id="nav-3-4-3-3">
    
    <label class="md-nav__link" for="nav-3-4-3-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-3-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../nek/" title="NekBone" class="md-nav__link">
      NekBone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../md/" title="MD" class="md-nav__link">
      MD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../resources/" title="Other Resources" class="md-nav__link">
      Other Resources
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="code-structure">Code Structure<a class="headerlink" href="#code-structure" title="Permanent link">&para;</a></h1>
<p>The typical form of a BoxLib application is a C++ "driver" code which manages
the boxes on the domain, and calls Fortran kernels in a loop over the boxes
owned by each MPI process. An example of this layout is shown below:</p>
<div class="codehilite"><pre><span></span><span class="c1">// Advance the solution one grid at a time</span>
<span class="k">for</span> <span class="p">(</span> <span class="n">MFIter</span> <span class="n">mfi</span><span class="p">(</span><span class="n">old_phi</span><span class="p">);</span> <span class="n">mfi</span><span class="p">.</span><span class="n">isValid</span><span class="p">();</span> <span class="o">++</span><span class="n">mfi</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">bx</span> <span class="o">=</span> <span class="n">mfi</span><span class="p">.</span><span class="n">validbox</span><span class="p">();</span>

  <span class="n">update_phi</span><span class="p">(</span><span class="n">old_phi</span><span class="p">[</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="n">new_phi</span><span class="p">[</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="o">&amp;</span><span class="n">ng_p</span><span class="p">,</span>
             <span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="o">&amp;</span><span class="n">ng_f</span><span class="p">,</span> <span class="n">bx</span><span class="p">.</span><span class="n">loVect</span><span class="p">(),</span> <span class="n">bx</span><span class="p">.</span><span class="n">hiVect</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dt</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Here the <code>MFIter</code> object is an iterator over boxes owned by an MPI process. The
<code>Box</code> object contains the geometric metadata describing a particular box, e.g.,
the indices of the lower and upper corners. The variables <code>old_phi</code>, <code>new_phi</code>,
and <code>flux</code> contain pointers to the arrays which contain the floating point data
on the grid. The <code>update_phi</code> function is a Fortran function which uses the
data from the <code>Box</code> object to construct 3-D loops over the appropriate section
of the three floating-point arrays. The function may look like the following:</p>
<div class="codehilite"><pre><span></span><span class="k">subroutine </span><span class="n">update_phi</span><span class="p">(</span><span class="n">phiold</span><span class="p">,</span> <span class="n">phinew</span><span class="p">,</span> <span class="n">ng_p</span><span class="p">,</span> <span class="n">fluxx</span><span class="p">,</span> <span class="n">fluxy</span><span class="p">,</span> <span class="n">fluxz</span><span class="p">,</span> <span class="n">ng_f</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;update_phi&quot;</span><span class="p">)</span>

  <span class="kt">integer</span>          <span class="kd">::</span> <span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ng_p</span><span class="p">,</span> <span class="n">ng_f</span>
  <span class="kt">double precision</span> <span class="kd">::</span> <span class="n">phiold</span><span class="p">(</span><span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ng_p</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ng_p</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">ng_p</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">ng_p</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">ng_p</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ng_p</span><span class="p">)</span>
  <span class="kt">double precision</span> <span class="kd">::</span> <span class="n">phinew</span><span class="p">(</span><span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ng_p</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ng_p</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">ng_p</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">ng_p</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">ng_p</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ng_p</span><span class="p">)</span>
  <span class="kt">double precision</span> <span class="kd">::</span>  <span class="n">fluxx</span><span class="p">(</span><span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="p">)</span>
  <span class="kt">double precision</span> <span class="kd">::</span>  <span class="n">fluxy</span><span class="p">(</span><span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="p">)</span>
  <span class="kt">double precision</span> <span class="kd">::</span>  <span class="n">fluxz</span><span class="p">(</span><span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="p">,</span><span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">ng_f</span><span class="p">:</span><span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ng_f</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="kt">double precision</span> <span class="kd">::</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dt</span>

  <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>

  <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
     <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

           <span class="n">phinew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">phiold</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">&amp;</span>
                <span class="p">(</span> <span class="n">fluxx</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">fluxx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
                <span class="o">+</span><span class="n">fluxy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">fluxy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
                <span class="o">+</span><span class="n">fluxz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">fluxz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">dx</span>

        <span class="k">end do</span>
<span class="k">     end do</span>
<span class="k">  end do</span>
</pre></div>

<p>The Fortran function constructs the appropriate "view" into each box using the
data from the <code>Box</code> object from the C++ function, as well as from the number of
ghost zones (<code>ng_p</code> for <code>old_phi</code> and <code>new_phi</code>, and <code>ng_f</code> for <code>flux</code>).</p>
<p>The above example demonstrates pure MPI parallelism; the analogous C++ code
which uses OpenMP tiling as described above would look like the following:</p>
<div class="codehilite"><pre><span></span><span class="c1">// Advance the solution one grid at a time</span>
<span class="cp">#ifdef _OPENMP</span>
<span class="cp">#pragma omp parallel</span>
<span class="cp">#endif</span>
<span class="k">for</span> <span class="p">(</span> <span class="n">MFIter</span> <span class="n">mfi</span><span class="p">(</span><span class="n">old_phi</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span> <span class="n">mfi</span><span class="p">.</span><span class="n">isValid</span><span class="p">();</span> <span class="o">++</span><span class="n">mfi</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">tbx</span> <span class="o">=</span> <span class="n">mfi</span><span class="p">.</span><span class="n">tilebox</span><span class="p">();</span>

  <span class="n">update_phi</span><span class="p">(</span><span class="n">old_phi</span><span class="p">[</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="n">new_phi</span><span class="p">[</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="o">&amp;</span><span class="n">ng_p</span><span class="p">,</span>
             <span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">mfi</span><span class="p">].</span><span class="n">dataPtr</span><span class="p">(),</span>
             <span class="o">&amp;</span><span class="n">ng_f</span><span class="p">,</span> <span class="n">tbx</span><span class="p">.</span><span class="n">loVect</span><span class="p">(),</span> <span class="n">tbx</span><span class="p">.</span><span class="n">hiVect</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dt</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The OpenMP parallelism is coarse-grained; rather than constructing a large
<code>Box</code> from <code>mfi.validbox()</code>, it constructs a smaller <code>Box</code> from
<code>mfi.tilebox()</code>. The metadata format remains unchanged, allowing the Fortran
function to remain unchanged as well.</p>
<h1 id="memory-management">Memory Management<a class="headerlink" href="#memory-management" title="Permanent link">&para;</a></h1>
<p>BoxLib abstracts the memory management by using the abstract <code>Arena</code> class.</p>
<p><div class="codehilite"><pre><span></span><span class="cp">#ifndef BL_ARENA_H</span>
<span class="cp">#define BL_ARENA_H</span>

<span class="cp">#include</span> <span class="cpf">&lt;winstd.H&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstddef&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">Arena</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">BoxLib</span>
<span class="p">{</span>
    <span class="n">Arena</span><span class="o">*</span> <span class="n">The_Arena</span> <span class="p">();</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="c1">// A Virtual Base Class for Dynamic Memory Management</span>
<span class="c1">//</span>
<span class="c1">// This is a virtual base class for objects that manage their own dynamic</span>
<span class="c1">// memory allocation.  Since it is a virtual base class, you have to derive</span>
<span class="c1">// something from it to use it.</span>
<span class="c1">//</span>

<span class="k">class</span> <span class="nc">Arena</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

    <span class="k">virtual</span> <span class="o">~</span><span class="n">Arena</span> <span class="p">();</span>
    <span class="c1">//</span>
    <span class="c1">// Allocate a dynamic memory arena of size sz.</span>
    <span class="c1">// A pointer to this memory should be returned.</span>
    <span class="c1">//</span>
    <span class="k">virtual</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">alloc</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">sz</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">//</span>
    <span class="c1">// A pure virtual function for deleting the arena pointed to by pt.</span>
    <span class="c1">//</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">free</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">pt</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">//</span>
    <span class="c1">// Given a minimum required arena size of sz bytes, this returns</span>
    <span class="c1">// the next largest arena size that will align to align_size bytes.</span>
    <span class="c1">//</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">align</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">sz</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>

    <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">align_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/*BL_ARENA_H*/</span><span class="cp"></span>
</pre></div>
The most general container class in BoxLib, the <code>BaseFab</code>, calls the <code>Arena</code> data allocator to allocate its memory. Therefore, by providing a specialized Arena-descendant, the user can easily plug in his own data containers or decorate his allocations with alignment or memory placing directives.</p>
<h1 id="c-kernel-rewrites">C++ Kernel Rewrites<a class="headerlink" href="#c-kernel-rewrites" title="Permanent link">&para;</a></h1>
<p>Some programming models do not support Fortran and thus for using those, we need to port our kernels to C++. Below we show the ported GSRB kernel. For the sake of simplicity, we work directly with the fabs and not with the data pointers as we do in Fortran, so that we can use the access operator to index into our data containers. </p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">C_GSRB_3D</span><span class="p">(</span>
<span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">bx</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">bbx</span><span class="p">,</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">nc</span><span class="p">,</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">rb</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Real</span> <span class="n">alpha</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Real</span> <span class="n">beta</span><span class="p">,</span>
<span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">phi</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">bX</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">bY</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">bZ</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f0</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Mask</span><span class="o">&amp;</span> <span class="n">m0</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f1</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Mask</span><span class="o">&amp;</span> <span class="n">m1</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f2</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Mask</span><span class="o">&amp;</span> <span class="n">m2</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f3</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Mask</span><span class="o">&amp;</span> <span class="n">m3</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f4</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Mask</span><span class="o">&amp;</span> <span class="n">m4</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f5</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Mask</span><span class="o">&amp;</span> <span class="n">m5</span><span class="p">,</span>
<span class="k">const</span> <span class="n">Real</span><span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//box extends:</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">loVect</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">hiVect</span><span class="p">();</span>
    <span class="c1">//blo</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">blo</span> <span class="o">=</span> <span class="n">bbx</span><span class="p">.</span><span class="n">loVect</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bhi</span> <span class="o">=</span> <span class="n">bbx</span><span class="p">.</span><span class="n">hiVect</span><span class="p">();</span>

    <span class="c1">//some parameters</span>
    <span class="n">Real</span> <span class="n">omega</span><span class="o">=</span> <span class="mf">1.15</span><span class="p">;</span>
    <span class="n">Real</span> <span class="n">dhx</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">Real</span> <span class="n">dhy</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">Real</span> <span class="n">dhz</span> <span class="o">=</span> <span class="n">beta</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="n">nc</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">ioff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">rb</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ioff</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

                    <span class="c1">//BC terms</span>
                    <span class="n">Real</span> <span class="n">cf0</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">blo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m0</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">blo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f0</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">blo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
                    <span class="n">Real</span> <span class="n">cf1</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">blo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m1</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f1</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
                    <span class="n">Real</span> <span class="n">cf2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="n">blo</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m2</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f2</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
                    <span class="n">Real</span> <span class="n">cf3</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">bhi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m3</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">bhi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f3</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">bhi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
                    <span class="n">Real</span> <span class="n">cf4</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">bhi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m4</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f4</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
                    <span class="n">Real</span> <span class="n">cf5</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="n">bhi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m5</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f5</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>

                    <span class="c1">//assign ORA constants</span>
                    <span class="kt">double</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">a</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
                                    <span class="o">+</span> <span class="n">dhx</span> <span class="o">*</span> <span class="p">(</span><span class="n">bX</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="n">bX</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)))</span>
                                    <span class="o">+</span> <span class="n">dhy</span> <span class="o">*</span> <span class="p">(</span><span class="n">bY</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="n">bY</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)))</span>
                                    <span class="o">+</span> <span class="n">dhz</span> <span class="o">*</span> <span class="p">(</span><span class="n">bZ</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="n">bZ</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)));</span>

                    <span class="kt">double</span> <span class="n">g_m_d</span> <span class="o">=</span> <span class="n">gamma</span>
                                    <span class="o">-</span> <span class="n">dhx</span> <span class="o">*</span> <span class="p">(</span><span class="n">bX</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">cf0</span> <span class="o">+</span> <span class="n">bX</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">cf3</span><span class="p">)</span>
                                    <span class="o">-</span> <span class="n">dhy</span> <span class="o">*</span> <span class="p">(</span><span class="n">bY</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">cf1</span> <span class="o">+</span> <span class="n">bY</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">cf4</span><span class="p">)</span>
                                    <span class="o">-</span> <span class="n">dhz</span> <span class="o">*</span> <span class="p">(</span><span class="n">bZ</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">cf2</span> <span class="o">+</span> <span class="n">bZ</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">cf5</span><span class="p">);</span>

                    <span class="kt">double</span> <span class="n">rho</span> <span class="o">=</span>  <span class="n">dhx</span> <span class="o">*</span> <span class="p">(</span><span class="n">bX</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">bX</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">n</span><span class="p">))</span>
                                <span class="o">+</span> <span class="n">dhy</span> <span class="o">*</span> <span class="p">(</span><span class="n">bY</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">bY</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">n</span><span class="p">))</span>
                                <span class="o">+</span> <span class="n">dhz</span> <span class="o">*</span> <span class="p">(</span><span class="n">bZ</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">bZ</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">n</span><span class="p">));</span>

                    <span class="kt">double</span> <span class="n">res</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="p">;</span>
                    <span class="n">phi</span><span class="p">(</span><span class="n">IntVect</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="o">+=</span> <span class="n">omega</span><span class="o">/</span><span class="n">g_m_d</span> <span class="o">*</span> <span class="n">res</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>We try to avoid porting all Fortran kernels for our explorations but some of the frameworks would basically require that. We will make comments about this in appropriate places.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../parallelism/" title="Parallelism" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Parallelism
              </span>
            </div>
          </a>
        
        
          <a href="../multigrid/" title="Geometric Multigrid" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Geometric Multigrid
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>