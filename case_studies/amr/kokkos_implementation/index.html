
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../../favicon.ico">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>Kokkos - Performance Portability</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="green" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Performance Portability" class="md-logo md-header-nav__button">
            <img src="../../../images/oos.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  BoxLib
                </span>
              
                <span class="md-header-nav__parent">
                  Implementations
                </span>
              
            
            Kokkos
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../../../images/oos.png">
      </i>
    
    Performance Portability
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Office of Science Facilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Office of Science Facilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/comparison/" title="Comparison" class="md-nav__link">
      Comparison
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Performance Portability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Performance Portability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/definition/" title="Definition" class="md-nav__link">
      Definition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Measurements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Measurements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/" title="Measurement Techniques" class="md-nav__link">
      Measurement Techniques
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/knl/" title="Collecting Roofline on KNL" class="md-nav__link">
      Collecting Roofline on KNL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/gpu/" title="Collecting Roofline on GPUs" class="md-nav__link">
      Collecting Roofline on GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/strategy/" title="Strategy" class="md-nav__link">
      Strategy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Approaches
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Approaches
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/libraries/" title="Libraries" class="md-nav__link">
      Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-2" type="checkbox" id="nav-3-5-2">
    
    <label class="md-nav__link" for="nav-3-5-2">
      Directives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-2">
        Directives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openacc/" title="OpenACC" class="md-nav__link">
      OpenACC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openmp/" title="OpenMP" class="md-nav__link">
      OpenMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-3" type="checkbox" id="nav-3-5-3">
    
    <label class="md-nav__link" for="nav-3-5-3">
      Frameworks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-3">
        Frameworks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/kokkos/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/raja/" title="RAJA" class="md-nav__link">
      RAJA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/dsl/" title="DSL" class="md-nav__link">
      DSL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6" checked>
    
    <label class="md-nav__link" for="nav-3-6">
      Case Studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        Case Studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-1" type="checkbox" id="nav-3-6-1" checked>
    
    <label class="md-nav__link" for="nav-3-6-1">
      BoxLib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-1">
        BoxLib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../parallelism/" title="Parallelism" class="md-nav__link">
      Parallelism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multigrid/" title="Geometric Multigrid" class="md-nav__link">
      Geometric Multigrid
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-1-5" type="checkbox" id="nav-3-6-1-5" checked>
    
    <label class="md-nav__link" for="nav-3-6-1-5">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-1-5">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Kokkos
      </label>
    
    <a href="./" title="Kokkos" class="md-nav__link md-nav__link--active">
      Kokkos
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-attempt" title="First Attempt" class="md-nav__link">
    First Attempt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-management" title="Memory Management" class="md-nav__link">
    Memory Management
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewriting-fortran-kernels" title="Rewriting Fortran Kernels" class="md-nav__link">
    Rewriting Fortran Kernels
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#second-attempt" title="Second Attempt" class="md-nav__link">
    Second Attempt
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../performance_comparison/" title="Performance" class="md-nav__link">
      Performance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2" type="checkbox" id="nav-3-6-2">
    
    <label class="md-nav__link" for="nav-3-6-2">
      BGW
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-2">
        BGW
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/code_structure/" title="Code structure" class="md-nav__link">
      Code structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2-3" type="checkbox" id="nav-3-6-2-3">
    
    <label class="md-nav__link" for="nav-3-6-2-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-2-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-3" type="checkbox" id="nav-3-6-3">
    
    <label class="md-nav__link" for="nav-3-6-3">
      QCD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-3">
        QCD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-3-3" type="checkbox" id="nav-3-6-3-3">
    
    <label class="md-nav__link" for="nav-3-6-3-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-3-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/results_summary/" title="Results" class="md-nav__link">
      Results
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../nek/" title="NekBone" class="md-nav__link">
      NekBone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../md/" title="MD" class="md-nav__link">
      MD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../resources/" title="Other Resources" class="md-nav__link">
      Other Resources
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#first-attempt" title="First Attempt" class="md-nav__link">
    First Attempt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-management" title="Memory Management" class="md-nav__link">
    Memory Management
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rewriting-fortran-kernels" title="Rewriting Fortran Kernels" class="md-nav__link">
    Rewriting Fortran Kernels
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#second-attempt" title="Second Attempt" class="md-nav__link">
    Second Attempt
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="kokkos-implementation">Kokkos Implementation<a class="headerlink" href="#kokkos-implementation" title="Permanent link">&para;</a></h1>
<p>This section is written as some kind of lab report, since we think that it illustrates best what challenges users might face when making complicated frameworks such as BoxLib performance portable.</p>
<h2 id="first-attempt">First Attempt<a class="headerlink" href="#first-attempt" title="Permanent link">&para;</a></h2>
<p>This section will describe our first, unfinished attempt, to port BoxLib over to Kokkos. The approach was designed to be the cleanest but also the most difficult one. We learned some lessons in the process which we want to share with the reader of this case study.</p>
<h3 id="memory-management">Memory Management<a class="headerlink" href="#memory-management" title="Permanent link">&para;</a></h3>
<p>In theory, one would like to make the data resident on the <em>device</em> all the time to avoid unnecessary data transfer. We thus implemented a <code>KArenaND</code> class which allows us to use Kokkos views instead of plain arrays for storing the data. This is the abstract, N-dimensional class which provides a part of the interface:</p>
<div class="codehilite"><pre><span></span><span class="c1">//generic ND template</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="kt">int</span> <span class="n">D</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">KArenaND</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="c1">//</span>
  <span class="c1">// Allocates a dynamic memory arena of size sz.</span>
  <span class="c1">// Returns a pointer to this memory.</span>
  <span class="c1">//</span>
  <span class="k">virtual</span> <span class="kt">void</span><span class="o">*</span> <span class="n">alloc</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;&amp;</span> <span class="n">_sz</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">protected</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">free</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>We then (partially) specialize this class in order generate a <code>KArena3D</code>-variant, as this is what we mostly use in our code. This class is defined as</p>
<div class="codehilite"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">KArenaND</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="mi">3</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="c1">//</span>
  <span class="c1">// Allocates a dynamic memory arena of size sz.</span>
  <span class="c1">// Returns a pointer to this memory.</span>
  <span class="c1">//</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">alloc</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;&amp;</span> <span class="n">sz_vec</span><span class="p">);</span>

  <span class="c1">// pass access operator through to simplify things</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">a0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">a0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">IntVect</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">IntVect</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// and return the view</span>
  <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">T</span><span class="o">***&gt;&amp;</span> <span class="n">viewData</span><span class="p">(){</span> <span class="k">return</span> <span class="n">view</span><span class="p">;</span> <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">free</span><span class="p">();</span>
  <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">T</span><span class="o">***&gt;</span> <span class="n">view</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>The corresponding allocator looks like then:</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">KArenaND</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="mi">3</span><span class="o">&gt;::</span><span class="n">alloc</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;&amp;</span> <span class="n">_sz_vec</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">_sz_vec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">3</span><span class="p">){</span>
    <span class="n">BoxLib</span><span class="o">::</span><span class="n">Abort</span><span class="p">(</span><span class="s">&quot;Error, the vector size passed to KArenaND has to be equal to its dimension!&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// important: reverse dimensions for optimal access</span>
  <span class="n">view</span> <span class="o">=</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">T</span><span class="o">***&gt;</span><span class="p">(</span><span class="s">&quot;KArena_view3D&quot;</span><span class="p">,</span><span class="n">_sz_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">_sz_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">_sz_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="c1">// provide interface compatibility with the rest of boxlib, but never use that pointer.</span>
  <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="n">ptr_on_device</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When packing Views into classes, avoid using pointers and the <code>new</code> operator to instantiate a new View. <strong>This pointer will be a host-only pointer and will have NULL value when accessed from a device which uses a different address space.</strong> The reference counting is only guaranteed to work properly if the View is stored and passed by value. In that sense, also avoid passing references to views. Note that Kokkos::Views are lightweight objects so there is no performance reason to use pointers/references instead of values in this case.</p>
</div>
<p>We further implemented operators to access the memory, which basically pass the View access operator to the outside. For example:</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;</span> <span class="n">KArenaND</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="mi">3</span><span class="o">&gt;::</span><span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">a0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// indices reversed compared to BoxLib</span>
  <span class="c1">// in roder to ensure interface compatibility</span>
  <span class="k">return</span> <span class="n">view</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="n">a0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Note that we reverse the order of indices here. This is because BoxLib uses the indexing <code>(x,y,z)</code> whereas for Kokkos views it is more convenient if the order <code>(z,y,x)</code> is used so that one can use Kokkos default layouts, i.e. <code>Layout::Left</code> on GPU and <code>Layout::Right</code> on CPU. If one would use the BoxLib indexing on the view level, this logic would need to be inverted whenever a Kokkos parallel dispatch is used. Instead, we invert it on the access operator level so that we neither need to explicitly specify an iteration policy nor break the BoxLib indexing order in the rest of the code.</p>
<p>There are advantages and disadvantages to burying the Kokkos data containers deep into the framework. The obvious advantage is that once it works, basically the majority of the framework will already be Kokkos compatible. The disadvantage is that incremental porting is not possible, it is an all-or-nothing approach.</p>
<h3 id="rewriting-fortran-kernels">Rewriting Fortran Kernels<a class="headerlink" href="#rewriting-fortran-kernels" title="Permanent link">&para;</a></h3>
<p>A big difficulty with porting the BoxLib GMG to Kokkos is that most of the kernels are written in Fortran. For Kokkos, we need those kernels in C++ so we have started rewriting those kernels accordingly. As it turns out, the Kokkos GMG tutorial touches many of these Fortran kernels, and so we stopped after altering almost 10K lines of code in about 50 files. Below you find the comparison between the BoxLib master branch from which we started to the current state of the Kokkos port branch.</p>
<div class="codehilite"><pre><span></span>~/BoxLib&gt; git diff --stat cpp_kernels_kokkos-views 

 Src/C_BaseLib/FArrayBox.H                            |    2 -
 Src/C_BaseLib/FabArray.H                             |    8 +-
 Src/C_BaseLib/IArrayBox.H                            |    1 -
 Src/C_BaseLib/KArena.H                               |  265 ---------
 Src/C_BaseLib/KBaseFab.H                             | 3615 -----------------------------------------------------------------------------------------------------------------
 Src/C_BaseLib/Looping.H                              |  770 +-----------------------
 Src/C_BaseLib/Make.package                           |    6 +-
 Src/C_BaseLib/MultiFabUtil.cpp                       |  284 +++++----
 Src/C_BaseLib/MultiFabUtil_3d.cpp                    |  247 --------
 Src/C_BaseLib/MultiFabUtil_F.H                       |    8 -
 Src/C_BoundaryLib/Mask.H                             |    1 -
 Src/C_BoundaryLib/Mask.cpp                           |    2 +-
 Src/LinearSolvers/C_CellMG/ABecLaplacian.H           |    9 +-
 Src/LinearSolvers/C_CellMG/ABecLaplacian.cpp         | 1119 ++++++++++++++++-------------------
 Src/LinearSolvers/C_CellMG/ABec_3D.F                 |    4 +-
 Src/LinearSolvers/C_CellMG/CGSolver.H                |    6 +-
 Src/LinearSolvers/C_CellMG/CGSolver.cpp              |   13 +-
 Src/LinearSolvers/C_CellMG/LO_3D_cpp.cpp             |  235 --------
 Src/LinearSolvers/C_CellMG/LO_F.H                    |    5 -
 Src/LinearSolvers/C_CellMG/Laplacian.H               |    3 +-
 Src/LinearSolvers/C_CellMG/Laplacian.cpp             |  343 ++++++-----
 Src/LinearSolvers/C_CellMG/LinOp.H                   |   12 +-
 Src/LinearSolvers/C_CellMG/LinOp.cpp                 |   85 +--
 Src/LinearSolvers/C_CellMG/MG_3D_cpp.cpp             |  464 ---------------
 Src/LinearSolvers/C_CellMG/MG_3D_fortran.F           |   96 ---
 Src/LinearSolvers/C_CellMG/MG_3D_old.cpp             |  222 -------
 Src/LinearSolvers/C_CellMG/MG_F.H                    |   81 ---
 Src/LinearSolvers/C_CellMG/Make.package              |    6 +-
 Src/LinearSolvers/C_CellMG/MultiGrid.H               |    4 +-
 Src/LinearSolvers/C_CellMG/MultiGrid.cpp             | 1463 +++++++++++++++++++++++-----------------------
 Src/LinearSolvers/C_CellMG/old/MG_3D_cpp.cpp-average |   39 --
 Src/LinearSolvers/C_CellMG4/ABec2.H                  |    5 +-
 Src/LinearSolvers/C_CellMG4/ABec4.H                  |    3 +-
 Src/LinearSolvers/C_CellMG4/ABec4.cpp                |    7 +-
 Tools/C_mk/Make.rules                                |    4 +-
 Tools/Postprocessing/F_Src/GNUmakefile               |    2 +-
 Tutorials/MultiGrid_C/COEF_3D.F90                    |   14 +-
 Tutorials/MultiGrid_C/COEF_F.H                       |   10 +-
 Tutorials/MultiGrid_C/GNUmakefile                    |   28 +-
 Tutorials/MultiGrid_C/KokkosCore_config.h            |   11 -
 Tutorials/MultiGrid_C/KokkosCore_config.tmp          |   11 -
 Tutorials/MultiGrid_C/MG_helpers_cpp.cpp             |  162 ------
 Tutorials/MultiGrid_C/Make.package                   |    2 +-
 Tutorials/MultiGrid_C/RHS_3D.F90                     |  143 ++---
 Tutorials/MultiGrid_C/RHS_F.H                        |    3 +-
 Tutorials/MultiGrid_C/fcompare                       |  Bin 3475616 -&gt; 0 bytes
 Tutorials/MultiGrid_C/inputs                         |    6 +-
 Tutorials/MultiGrid_C/main.cpp                       | 1530 ++++++++++++++++++++++++------------------------
 Tutorials/MultiGrid_C/out-F                          |  522 -----------------
 Tutorials/MultiGrid_C/out-cpp                        |  522 -----------------
 55 files changed, 2455 insertions(+), 10764 deletions(-)
</pre></div>

<p>Clearly, this is a major endeavor and we stopped our explorations for the moment at this point. 
Furthermore, it is not clear what performance Kokkos can deliver for the tasks at hand. To assess that, we abandoned the full port and continued with a partial port described below.</p>
<h2 id="second-attempt">Second Attempt<a class="headerlink" href="#second-attempt" title="Permanent link">&para;</a></h2>
<p>Since porting the full application is a major effort but we still want to assess Kokkos' potential for BoxLib, we followed a different strategy in this attempt: we will port all performance relevant GMG kernels to Kokkos, copying data into a suitable view before calling the kernel, then using Kokkos' parallel dispatcher to launch the kernels, and then fill the results back into BoxLib's own <code>BaseFab</code> datatype. 
It is important to note that BoxLib uses offsets in the array-indexing and those can be different for different fields (e.g. some fields have ghost zones and some do not).</p>
<p>We thus decided to encapsulate this complexity into a new class. Below we show the declaration of the one specialized for <code>FArraBox</code> datatypes, i.e. <code>BaseFab</code> instances with types <code>Real</code>.</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="k">class</span> <span class="nc">ViewFab</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

  <span class="c1">// swap indices here to get kokkos&#39;-canonical layout</span>
  <span class="n">KOKKOS_INLINE_FUNCTION</span>
  <span class="n">Real</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">j</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="n">KOKKOS_INLINE_FUNCTION</span>
  <span class="n">Real</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">j</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">rhs_</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name_</span><span class="p">);</span>

  <span class="n">ViewFab</span><span class="p">(){}</span>

  <span class="n">ViewFab</span><span class="p">(</span><span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">rhs_</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name_</span><span class="p">){</span>
      <span class="n">init</span><span class="p">(</span><span class="n">rhs_</span><span class="p">,</span><span class="n">name_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">ViewFab</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">&gt;&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">ViewFab</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">&gt;&amp;</span> <span class="n">rhs_</span><span class="p">);</span>

  <span class="c1">// write the view data into a FArrayBox</span>
  <span class="kt">void</span> <span class="nf">fill</span><span class="p">(</span><span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">lhs_</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numvars</span><span class="p">;</span>
  <span class="n">IntVect</span> <span class="n">smallend</span><span class="p">,</span> <span class="n">bigend</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
  <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">****&gt;</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>The important aspect is that the access operator hides the offset indexing and thus keeps the kernels clean.
Note that this class is similar to what we try to use in our first attempt, but this time we do not bury it deep into the Framework but rather only use it for making the individual kernels performance portable. The access operators need to be decorated with <code>KOKKOS_INLINE_FUNCTION</code> macros because they will be called from the device. In order to copy relevant <em>metadata</em> to the device, we use the functor approach. That means we pack all relevant parameters into a functor object and then provide an access operator to it. For example, the average (restriction) functor is</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">C_AVERAGE_FUNCTOR</span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">C_AVERAGE_FUNCTOR</span><span class="p">(</span><span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">c_</span><span class="p">,</span> <span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f_</span><span class="p">)</span> <span class="o">:</span> <span class="n">cv</span><span class="p">(</span><span class="n">c_</span><span class="p">,</span><span class="s">&quot;cv&quot;</span><span class="p">),</span> <span class="n">fv</span><span class="p">(</span><span class="n">f_</span><span class="p">,</span><span class="s">&quot;fv&quot;</span><span class="p">){</span>
    <span class="n">cv</span><span class="p">.</span><span class="n">syncH2D</span><span class="p">();</span>
    <span class="n">fv</span><span class="p">.</span><span class="n">syncH2D</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">KOKKOS_INLINE_FUNCTION</span>
  <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
    <span class="n">cv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span>  <span class="p">(</span><span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mf">0.125</span><span class="p">;</span>
    <span class="n">cv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mf">0.125</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">fill</span><span class="p">(</span><span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">cfab</span><span class="p">){</span>
    <span class="n">cv</span><span class="p">.</span><span class="n">syncD2H</span><span class="p">();</span>
    <span class="n">cv</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">cfab</span><span class="p">);</span>
  <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">ViewFab</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">&gt;</span> <span class="n">cv</span><span class="p">,</span> <span class="n">fv</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>It contains the two viewfabs needed and makes sure that data is uploaded to and downloaded from the device when needed. The average-kernel then simply becomes:</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">C_AVERAGE</span><span class="p">(</span>
<span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">bx</span><span class="p">,</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">nc</span><span class="p">,</span>
<span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">,</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f</span><span class="p">){</span>

  <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">loVect</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">hiVect</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">cbVect</span><span class="p">();</span>

  <span class="c1">// create functor</span>
  <span class="n">C_AVERAGE_FUNCTOR</span> <span class="n">cavfunc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>

  <span class="c1">// define policy</span>
  <span class="k">typedef</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">MDRangePolicy</span><span class="o">&lt;</span><span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">Rank</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">t_policy</span><span class="p">;</span>

  <span class="c1">// execute</span>
  <span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">md_parallel_for</span><span class="p">(</span><span class="n">t_policy</span><span class="p">({</span><span class="mi">0</span><span class="p">,</span> <span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]},{</span><span class="n">nc</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">},{</span><span class="n">nc</span><span class="p">,</span> <span class="n">cb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">]}),</span><span class="n">cavfunc</span><span class="p">);</span>

  <span class="c1">// write back</span>
  <span class="n">cavfunc</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>In order to employ loop-collapsing and additional cache blocking, we use the experimental multi-dimensional iteration policy feature. We added a cache-block-sizes vector <code>cb</code> which can be specified in the input file passed to the application. Most kernels can be ported like the one in the above example. The GSRB kernel though has non-unit stride access in the <code>i</code> loop, because of the red-black iteration pattern. For this case, we pass half of the actual range to the iteration policy and expand the index inside the loop. The access operator of the corresponding functor becomes</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="n">C_GSRB_FUNCTOR</span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="p">...</span>

  <span class="n">KOKKOS_INLINE_FUNCTION</span>
  <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>

    <span class="kt">int</span> <span class="n">ioff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">rb</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="n">lo0</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo0</span> <span class="o">+</span> <span class="n">ioff</span><span class="p">;</span>

    <span class="c1">//be careful to not run over</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">hi0</span><span class="p">){</span>

      <span class="c1">// boundary condition terms</span>
      <span class="n">Real</span> <span class="n">cf0</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">blo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m0v</span><span class="p">(</span><span class="n">blo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f0v</span><span class="p">(</span><span class="n">blo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
      <span class="n">Real</span> <span class="n">cf1</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">blo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m1v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f1v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">k</span><span class="p">)</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
      <span class="n">Real</span> <span class="n">cf2</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="n">blo</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m2v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f2v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">blo</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
      <span class="n">Real</span> <span class="n">cf3</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">bhi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m3v</span><span class="p">(</span><span class="n">bhi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f3v</span><span class="p">(</span><span class="n">bhi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
      <span class="n">Real</span> <span class="n">cf4</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">bhi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m4v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f4v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">k</span><span class="p">)</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>
      <span class="n">Real</span> <span class="n">cf5</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="n">bhi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m5v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">f5v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">bhi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.</span> <span class="p">);</span>

      <span class="c1">// assign overrelaxation constants</span>
      <span class="kt">double</span> <span class="n">gamma</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">*</span> <span class="n">av</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">dhx</span> <span class="o">*</span> <span class="p">(</span><span class="n">bXv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bXv</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
                    <span class="o">+</span> <span class="n">dhy</span> <span class="o">*</span> <span class="p">(</span><span class="n">bYv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bYv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
                    <span class="o">+</span> <span class="n">dhz</span> <span class="o">*</span> <span class="p">(</span><span class="n">bZv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bZv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

      <span class="kt">double</span> <span class="n">g_m_d</span> <span class="o">=</span>  <span class="n">gamma</span>
                    <span class="o">-</span> <span class="n">dhx</span> <span class="o">*</span> <span class="p">(</span><span class="n">bXv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf0</span> <span class="o">+</span> <span class="n">bXv</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf3</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">dhy</span> <span class="o">*</span> <span class="p">(</span><span class="n">bYv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf1</span> <span class="o">+</span> <span class="n">bYv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf4</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">dhz</span> <span class="o">*</span> <span class="p">(</span><span class="n">bZv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf2</span> <span class="o">+</span> <span class="n">bZv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cf5</span><span class="p">);</span>

      <span class="kt">double</span> <span class="n">rho</span> <span class="o">=</span>  <span class="n">dhx</span> <span class="o">*</span> <span class="p">(</span><span class="n">bXv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">bXv</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
                  <span class="o">+</span> <span class="n">dhy</span> <span class="o">*</span> <span class="p">(</span><span class="n">bYv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">bYv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
                  <span class="o">+</span> <span class="n">dhz</span> <span class="o">*</span> <span class="p">(</span><span class="n">bZv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">bZv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">));</span>

      <span class="kt">double</span> <span class="n">res</span> <span class="o">=</span> <span class="n">rhsv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho</span><span class="p">;</span>
      <span class="n">phiv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+=</span> <span class="n">omega</span><span class="o">/</span><span class="n">g_m_d</span> <span class="o">*</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<p>Note that we still have to avoid running over array bounds. That can occur when the grid extent in <code>i</code>-direction is odd. The iteration policy now becomes</p>
<div class="codehilite"><pre><span></span><span class="c1">// instantiate functor</span>
<span class="n">C_GSRB_FUNCTOR</span> <span class="nf">cgsrbfunc</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">bbx</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">bX</span><span class="p">,</span> <span class="n">bY</span><span class="p">,</span> <span class="n">bZ</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">m3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">m4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">m5</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

<span class="c1">// compute bounds used in i-iteration</span>
<span class="kt">int</span> <span class="n">length0</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">(</span> <span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">);</span>
<span class="kt">int</span> <span class="n">up0</span> <span class="o">=</span> <span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">length0</span><span class="p">;</span>

<span class="c1">// dispatch kernel</span>
<span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">md_parallel_for</span><span class="p">(</span><span class="n">t_policy</span><span class="p">({</span><span class="mi">0</span><span class="p">,</span> <span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span> <span class="p">{</span><span class="n">nc</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">up0</span><span class="o">+</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="n">nc</span><span class="p">,</span> <span class="n">cb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">length0</span><span class="p">}),</span> <span class="n">cgsrbfunc</span><span class="p">);</span>
</pre></div>

<p>We experimented with including the full loop over <code>i</code> into our iteration policy and then skipping the iteration if <code>(i + j + k) % 2 != 0</code>, but that decreased performance on the CPU by more than 50%. In general, it would be good if Kokkos' range policies allow for strided iterations.</p>
<p>The above approach clearly comes with data transfer overhead which we would have avoided if we would have followed through our first attempt. However, in the performance timings we will report later on, we explicitly exclude that overhead and just assess the run time of the kernels themselves. That way, we can determine if Kokkos is a viable framework for ensuring performance portability of BoxLib across architectures.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../multigrid/" title="Geometric Multigrid" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Geometric Multigrid
              </span>
            </div>
          </a>
        
        
          <a href="../openmp_implementation/" title="OpenMP 4.x" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                OpenMP 4.x
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>