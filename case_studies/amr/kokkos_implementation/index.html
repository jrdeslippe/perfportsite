
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>Kokkos - Performance Portability</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="green" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Performance Portability" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  BoxLib
                </span>
              
                <span class="md-header-nav__parent">
                  Implementations
                </span>
              
            
            Kokkos
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Performance Portability
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Office of Science Facilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Office of Science Facilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/comparison/" title="Comparison" class="md-nav__link">
      Comparison
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Performance Portability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Performance Portability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/definition/" title="Definition" class="md-nav__link">
      Definition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Measurements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Measurements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/" title="Measurement Techniques" class="md-nav__link">
      Measurement Techniques
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/knl/" title="Collecting Roofline on KNL" class="md-nav__link">
      Collecting Roofline on KNL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/gpu/" title="Collecting Roofline on GPUs" class="md-nav__link">
      Collecting Roofline on GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/strategy/" title="Strategy" class="md-nav__link">
      Strategy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Approaches
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Approaches
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/libraries/" title="Libraries" class="md-nav__link">
      Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-2" type="checkbox" id="nav-3-5-2">
    
    <label class="md-nav__link" for="nav-3-5-2">
      Directives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-2">
        Directives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openacc/" title="OpenACC" class="md-nav__link">
      OpenACC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openmp/" title="OpenMP" class="md-nav__link">
      OpenMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-3" type="checkbox" id="nav-3-5-3">
    
    <label class="md-nav__link" for="nav-3-5-3">
      Frameworks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-3">
        Frameworks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/kokkos/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/raja/" title="RAJA" class="md-nav__link">
      RAJA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/dsl/" title="DSL" class="md-nav__link">
      DSL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6" checked>
    
    <label class="md-nav__link" for="nav-3-6">
      Case Studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        Case Studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-1" type="checkbox" id="nav-3-6-1" checked>
    
    <label class="md-nav__link" for="nav-3-6-1">
      BoxLib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-1">
        BoxLib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../parallelism/" title="Parallelism" class="md-nav__link">
      Parallelism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multigrid/" title="Geometric Multigrid" class="md-nav__link">
      Geometric Multigrid
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-1-5" type="checkbox" id="nav-3-6-1-5" checked>
    
    <label class="md-nav__link" for="nav-3-6-1-5">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-1-5">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Kokkos
      </label>
    
    <a href="./" title="Kokkos" class="md-nav__link md-nav__link--active">
      Kokkos
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-management" title="Memory Management" class="md-nav__link">
    Memory Management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-implementation" title="Kernel Implementation" class="md-nav__link">
    Kernel Implementation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../performance_comparison/" title="Performance" class="md-nav__link">
      Performance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2" type="checkbox" id="nav-3-6-2">
    
    <label class="md-nav__link" for="nav-3-6-2">
      BGW
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-2">
        BGW
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/code_structure/" title="Code structure" class="md-nav__link">
      Code structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2-3" type="checkbox" id="nav-3-6-2-3">
    
    <label class="md-nav__link" for="nav-3-6-2-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-2-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-3" type="checkbox" id="nav-3-6-3">
    
    <label class="md-nav__link" for="nav-3-6-3">
      QCD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-3">
        QCD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-3-3" type="checkbox" id="nav-3-6-3-3">
    
    <label class="md-nav__link" for="nav-3-6-3-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-3-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/results_summary/" title="Results" class="md-nav__link">
      Results
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../nek/" title="NekBone" class="md-nav__link">
      NekBone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../md/" title="MD" class="md-nav__link">
      MD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../resources/" title="Other Resources" class="md-nav__link">
      Other Resources
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#memory-management" title="Memory Management" class="md-nav__link">
    Memory Management
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kernel-implementation" title="Kernel Implementation" class="md-nav__link">
    Kernel Implementation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="kokkos-implementation">Kokkos Implementation<a class="headerlink" href="#kokkos-implementation" title="Permanent link">&para;</a></h1>
<p>This section is written as some kind of lab report, since we think that it illustrates best what challenges users might face when making complicated frameworks such as BoxLib performance portable.</p>
<h2 id="memory-management">Memory Management<a class="headerlink" href="#memory-management" title="Permanent link">&para;</a></h2>
<p>Kokkos provides the <code>Kokkos::View</code> class for managing data and providing accessors to array elements, slicing etc.. The advantage is that the user does not need to know how the data is stored under the hood, i.e. if it is aligned, padded, strided, etc.. However, this approach also requires the user to only use the provided accessor functions to access the data or runtime errors might occur. One method to circumvent this problem are <em>unmanaged views</em>: here, the user allocates an array the regular way and defines a view on top of that. This approach is goo for incremental porting as it does not break existing functionality, but comes with certain disadvantages we will discuss below. Another difficulty is that <code>Kokkos::Views</code>, managed or unmanaged, do not support offset or negative indexing but those type of indexing is used frequently in BoxLib. We worked around this by implementing a small, lightweight <code>ViewFab</code> class:</p>
<div class="codehilite"><pre><span></span><span class="c1">// some useful typedefs and aliases</span>
<span class="c1">// this is always unmanaged</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">hostview</span> <span class="o">=</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">LayoutLeft</span><span class="p">,</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">HostSpace</span><span class="p">,</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">MemoryUnmanaged</span><span class="o">&gt;</span><span class="p">;</span>
<span class="cp">#ifdef KOKKOS_ENABLE_CUDA</span>
<span class="c1">// device view is a managed CUDA-view</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">devview</span> <span class="o">=</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">LayoutLeft</span><span class="p">,</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">CudaSpace</span><span class="o">&gt;</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="c1">//device view is a managed host-view</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">devview</span> <span class="o">=</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">LayoutLeft</span><span class="p">,</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">HostSpace</span><span class="o">&gt;</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="c1">// a small class for wrapping kokkos views nicely</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">ViewFab</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

<span class="cp">#if BL_SPACEDIM == 3</span>
  <span class="n">hostview</span><span class="o">&lt;</span><span class="n">T</span><span class="o">****&gt;</span> <span class="n">h_data</span><span class="p">;</span>
  <span class="n">devview</span><span class="o">&lt;</span><span class="n">T</span><span class="o">****&gt;</span> <span class="n">d_data</span><span class="p">;</span>
  <span class="c1">// access operator</span>
  <span class="n">KOKKOS_FORCEINLINE_FUNCTION</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">d_data</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="o">-</span><span class="n">smallend</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;ViewFab only supports 3D!&quot;;</span>
<span class="cp">#endif</span>
  <span class="kt">int</span> <span class="n">smallend</span><span class="p">[</span><span class="n">BL_SPACEDIM</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

  <span class="kt">void</span> <span class="nf">syncH2D</span><span class="p">(){</span>
    <span class="n">Kokkos</span><span class="o">::</span><span class="n">deep_copy</span><span class="p">(</span><span class="n">d_data</span><span class="p">,</span><span class="n">h_data</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">syncD2H</span><span class="p">(){</span>
    <span class="n">Kokkos</span><span class="o">::</span><span class="n">deep_copy</span><span class="p">(</span><span class="n">h_data</span><span class="p">,</span><span class="n">d_data</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">};</span>
</pre></div>

<p>This class could trivially be implemented for any dimension but we restricted ourselves to the interesting three dimensional case. We also wrapped up- and download functions in order to facilitate host-device-synchronization. In order to provide backwards compatibility, it is important that both layouts, i.e. for device and host, match BoxLibs column-order layout. 
We then embedded this class into BoxLibs main data container <code>BaseFab</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">BaseFab</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

  <span class="p">...</span>

  <span class="n">ViewFab</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">view_fab</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>All what is left to do is to define the view inside the <code>BaseFab</code> allocator function:</p>
<div class="codehilite"><pre><span></span><span class="n">aseFab</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">define</span> <span class="p">()</span>
<span class="p">{</span>

  <span class="c1">// This is the standard BoxLib allocator</span>
  <span class="n">BL_ASSERT</span><span class="p">(</span><span class="n">nvar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">BL_ASSERT</span><span class="p">(</span><span class="n">dptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">BL_ASSERT</span><span class="p">(</span><span class="n">numpts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">BL_ASSERT</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">long</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">nvar</span> <span class="o">&gt;</span> <span class="n">numpts</span><span class="p">);</span>

  <span class="n">truesize</span>  <span class="o">=</span> <span class="n">nvar</span><span class="o">*</span><span class="n">numpts</span><span class="p">;</span>
  <span class="n">dptr</span>      <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">BoxLib</span><span class="o">::</span><span class="n">The_Arena</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">truesize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)));</span>
  <span class="n">ptr_owner</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="c1">//</span>
  <span class="c1">// Now call T::T() on the raw memory so we have valid Ts.</span>
  <span class="c1">//</span>
  <span class="n">T</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">dptr</span><span class="p">;</span>
  <span class="c1">//</span>
  <span class="c1">// Note this must be long not int for very large (e.g.,1024^3) boxes.</span>
  <span class="c1">//</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">truesize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">new</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="n">T</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// This is the View construction</span>
  <span class="p">{</span>
    <span class="c1">//copy offset</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">BL_SPACEDIM</span><span class="p">;</span> <span class="o">++</span><span class="n">d</span><span class="p">){</span>
      <span class="n">view_fab</span><span class="p">.</span><span class="n">smallend</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="n">smallEnd</span><span class="p">()[</span><span class="n">d</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">view_fab</span><span class="p">.</span><span class="n">smallend</span><span class="p">[</span><span class="n">BL_SPACEDIM</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="c1">// create host view</span>
<span class="cp">#if BL_SPACEDIM == 3</span>
    <span class="n">view_fab</span><span class="p">.</span><span class="n">h_data</span> <span class="o">=</span> <span class="n">hostview</span><span class="o">&lt;</span><span class="n">T</span><span class="o">****&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">dataPtr</span><span class="p">()),</span> 
                                      <span class="n">length</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
                                      <span class="n">length</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> 
                                      <span class="n">length</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> 
                                      <span class="n">nComp</span><span class="p">());</span>
    <span class="n">view_fab</span><span class="p">.</span><span class="n">d_data</span> <span class="o">=</span> <span class="n">devview</span><span class="o">&lt;</span><span class="n">T</span><span class="o">****&gt;</span><span class="p">(</span><span class="n">Kokkos</span><span class="o">::</span><span class="n">ViewAllocateWithoutInitializing</span><span class="p">(</span><span class="s">&quot;BoxLib&quot;</span><span class="p">),</span> 
                                     <span class="n">length</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> 
                                     <span class="n">length</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> 
                                     <span class="n">length</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> 
                                     <span class="n">nComp</span><span class="p">());</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;ViewFab construction only supports 3D!&quot;;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="n">BoxLib</span><span class="o">::</span><span class="n">update_fab_stats</span><span class="p">(</span><span class="n">numpts</span><span class="p">,</span> <span class="n">truesize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>

<p>Note that we do not need to initialize the device data to zero because we will do that on the host and upload the data before we are going to use it on the device. 
This construct allows us to use Kokkos parallel dispatchers which work on the embedded <code>ViewFab</code> as well as the conventional BoxLib kernels working with raw data pointers <code>ptr</code>. We only need to make sure to synchronize data between host and device before using them on either one. </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Our current implementation relies on either having the same data layout on host and device or on <code>Kokkos::deep_copy</code> being aware of possibile differences between data layouts. For example, the unmanaged view is unpadded but in theory a managed view could be padded. Since the device view is a managed view, a data transfer routine for synchronizing device and host memory needs to be aware of that. The current state of Kokkos is that <code>Kokkos::deep_copy</code> is not aware of these things but also managed views are never padded. As long as this does not change, our approach is safe. However, it implicitly assumes knowledge about how Kokkos stores the data which is not optimal. In any case, we found that this is the only way to enable incremental code porting with Kokkos. </p>
</div>
<h2 id="kernel-implementation">Kernel Implementation<a class="headerlink" href="#kernel-implementation" title="Permanent link">&para;</a></h2>
<p>By implementing the memory management into the base container class, we make sure that all obejcts we are going to deal with have a view associated with it. The next step is to rewrite all kernels involved in the multigrid cycle. Although some of the kernels might not benefit from GPU acceleration, we nervetheless want to execute them on the device in order to avoid costly data copies. The example below shows out Kokkos implementation for the restriction kernel (average). </p>
<div class="codehilite"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">dim</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mdpolicy</span> <span class="o">=</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">MDRangePolicy</span><span class="o">&lt;</span>
                              <span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">Rank</span><span class="o">&lt;</span><span class="n">dim</span><span class="p">,</span> <span class="n">outer_iter_policy</span><span class="p">,</span> <span class="n">inner_iter_policy</span><span class="o">&gt;</span><span class="p">,</span> 
                              <span class="n">Kokkos</span><span class="o">::</span><span class="n">IndexType</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Average Functor</span>
<span class="k">struct</span> <span class="n">C_AVERAGE_FUNCTOR</span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">C_AVERAGE_FUNCTOR</span><span class="p">(</span><span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">c_</span><span class="p">,</span> <span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f_</span><span class="p">)</span> 
  <span class="o">:</span> <span class="n">cv</span><span class="p">(</span><span class="n">c_</span><span class="p">.</span><span class="n">view_fab</span><span class="p">),</span> <span class="n">fv</span><span class="p">(</span><span class="n">f_</span><span class="p">.</span><span class="n">view_fab</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">KOKKOS_FORCEINLINE_FUNCTION</span>
  <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
    <span class="n">cv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span>  <span class="p">(</span><span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mf">0.125</span><span class="p">;</span>
    <span class="n">cv</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fv</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mf">0.125</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">ViewFab</span><span class="o">&lt;</span><span class="n">Real</span><span class="o">&gt;</span> <span class="n">cv</span><span class="p">,</span> <span class="n">fv</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">//Average Kernel</span>
<span class="kt">void</span> <span class="nf">C_AVERAGE</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">bx</span><span class="p">,</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">nc</span><span class="p">,</span>
  <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">loVect</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hi</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">hiVect</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">bx</span><span class="p">.</span><span class="n">cbVect</span><span class="p">();</span>

  <span class="c1">// create functor</span>
  <span class="n">C_AVERAGE_FUNCTOR</span> <span class="n">cavfunc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>

  <span class="c1">// execute functor</span>
  <span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">md_parallel_for</span><span class="p">(</span><span class="n">mdpolicy</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">({</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">},</span> 
                                                    <span class="p">{</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nc</span><span class="p">},</span> 
                                                    <span class="p">{</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nc</span><span class="p">}),</span> <span class="n">cavfunc</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>We ported about 40 kernels in similar but straightforward fashion. The most effort here went into porting these kernels from Fortran to C++ since Kokkos does not work natively with Fortran. Once the C++-versions of the kernels were implemented and tested, applying Kokkos dispatchers to those is uncomplicated and relatively quick. 
In case of the GSRB kernel we had to work around the limitation that the innermost loop does not have stride-1 access because of the checkerboarding and Kokkos does not support that kind of access yet. We circumvented that issue by making the loop canonical, i.e. dividing the tripcount by two and expanding the innermost index accordingly inside the kernel: the code below shows how the dispatcher was implemented:</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">length0</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">(</span> <span class="p">(</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">);</span>
<span class="kt">int</span> <span class="n">up0</span> <span class="o">=</span> <span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">length0</span><span class="p">;</span>
<span class="n">Kokkos</span><span class="o">::</span><span class="n">Experimental</span><span class="o">::</span><span class="n">md_parallel_for</span><span class="p">(</span><span class="n">mdpolicy</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">({</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">},</span> 
                                                  <span class="p">{</span><span class="n">up0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nc</span><span class="p">},</span> 
                                                  <span class="p">{</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nc</span><span class="p">}),</span> 
                                                  <span class="n">cgsrbfunc</span><span class="p">);</span>
</pre></div>

<p>and below is the index expansion inside the loop body:</p>
<div class="codehilite"><pre><span></span><span class="n">KOKKOS_FORCEINLINE_FUNCTION</span>
<span class="kt">void</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ii</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
  <span class="kt">int</span> <span class="n">ioff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">rb</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="n">lo0</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo0</span> <span class="o">+</span> <span class="n">ioff</span><span class="p">;</span>

  <span class="c1">// if the i-dimension is odd, we could still run over, so better check</span>
  <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">hi0</span><span class="p">){</span>

    <span class="c1">// kernel body</span>

    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The <code>MDRangePolicy</code> policy is very useful as it is able to collapse loops, apply cache blocking and improve vectorization at the same time. We control the cacheblock sizes for each dimension <code>cb[i]</code> with corresponding lines in the input file.</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>Porting the BoxLib GMG to Kokkos was not trivial because of the plethora of Fortran kernels. One should be aware of this if one aims at making a legacy Fortran code performance portable. Also, incremental porting with Kokkos is doable but one has to utilize unmanaged views or raw data pointers of managed views. Both is, according to the user manual, not recommended because the user makes underlying assumptions on the internal data layout. However, within a short amount of time, we were able to port the BoxLib GMG solver and all involved routines to Kokkos and achieved <a href="../performance_comparison/">satisfying performance</a>. In the future, one could investigate further optimizations on the kernel-level, e.g. improve cache blocking/register use, device occupancy etc..</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../multigrid/" title="Geometric Multigrid" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Geometric Multigrid
              </span>
            </div>
          </a>
        
        
          <a href="../openmp_implementation/" title="OpenMP 4.x" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                OpenMP 4.x
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>