
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../../favicon.ico">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>Geometric Multigrid - Performance Portability</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="green" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Performance Portability" class="md-logo md-header-nav__button">
            <img src="../../../images/oos.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Case Studies
                </span>
              
                <span class="md-header-nav__parent">
                  BoxLib
                </span>
              
            
            Geometric Multigrid
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../../../images/oos.png">
      </i>
    
    Performance Portability
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Office of Science Facilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Office of Science Facilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/comparison/" title="Comparison" class="md-nav__link">
      Comparison
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Performance Portability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Performance Portability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/definition/" title="Definition" class="md-nav__link">
      Definition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Measurements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Measurements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/" title="Measurement Techniques" class="md-nav__link">
      Measurement Techniques
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/knl/" title="Collecting Roofline on KNL" class="md-nav__link">
      Collecting Roofline on KNL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/gpu/" title="Collecting Roofline on GPUs" class="md-nav__link">
      Collecting Roofline on GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/strategy/" title="Strategy" class="md-nav__link">
      Strategy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Approaches
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Approaches
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/libraries/" title="Libraries" class="md-nav__link">
      Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-2" type="checkbox" id="nav-3-5-2">
    
    <label class="md-nav__link" for="nav-3-5-2">
      Directives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-2">
        Directives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openacc/" title="OpenACC" class="md-nav__link">
      OpenACC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openmp/" title="OpenMP" class="md-nav__link">
      OpenMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-3" type="checkbox" id="nav-3-5-3">
    
    <label class="md-nav__link" for="nav-3-5-3">
      Frameworks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-3">
        Frameworks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/kokkos/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/raja/" title="RAJA" class="md-nav__link">
      RAJA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/dsl/" title="DSL" class="md-nav__link">
      DSL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6" checked>
    
    <label class="md-nav__link" for="nav-3-6">
      Case Studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        Case Studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-1" type="checkbox" id="nav-3-6-1" checked>
    
    <label class="md-nav__link" for="nav-3-6-1">
      BoxLib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-1">
        BoxLib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../parallelism/" title="Parallelism" class="md-nav__link">
      Parallelism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Geometric Multigrid
      </label>
    
    <a href="./" title="Geometric Multigrid" class="md-nav__link md-nav__link--active">
      Geometric Multigrid
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#relaxation" title="Relaxation" class="md-nav__link">
    Relaxation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restriction" title="Restriction" class="md-nav__link">
    Restriction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prolongation" title="Prolongation" class="md-nav__link">
    Prolongation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exact-linear-solve" title="Exact linear solve" class="md-nav__link">
    Exact linear solve
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-1-5" type="checkbox" id="nav-3-6-1-5">
    
    <label class="md-nav__link" for="nav-3-6-1-5">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-1-5">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../performance_comparison/" title="Performance" class="md-nav__link">
      Performance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2" type="checkbox" id="nav-3-6-2">
    
    <label class="md-nav__link" for="nav-3-6-2">
      BGW
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-2">
        BGW
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/code_structure/" title="Code structure" class="md-nav__link">
      Code structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2-3" type="checkbox" id="nav-3-6-2-3">
    
    <label class="md-nav__link" for="nav-3-6-2-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-2-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/openmp_implementation/" title="OpenMP 4.x" class="md-nav__link">
      OpenMP 4.x
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-3" type="checkbox" id="nav-3-6-3">
    
    <label class="md-nav__link" for="nav-3-6-3">
      QCD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-3">
        QCD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-3-3" type="checkbox" id="nav-3-6-3-3">
    
    <label class="md-nav__link" for="nav-3-6-3-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-6-3-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../qcd/results_summary/" title="Results" class="md-nav__link">
      Results
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../nek/" title="NekBone" class="md-nav__link">
      NekBone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../md/" title="MD" class="md-nav__link">
      MD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../resources/" title="Other Resources" class="md-nav__link">
      Other Resources
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#relaxation" title="Relaxation" class="md-nav__link">
    Relaxation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restriction" title="Restriction" class="md-nav__link">
    Restriction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prolongation" title="Prolongation" class="md-nav__link">
    Prolongation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exact-linear-solve" title="Exact linear solve" class="md-nav__link">
    Exact linear solve
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="geometric-multigrid">Geometric Multigrid<a class="headerlink" href="#geometric-multigrid" title="Permanent link">&para;</a></h1>
<p>Many problems encountered in BoxLib applications require solutions to linear
system, e.g., <a href="https://en.wikipedia.org/wiki/Elliptic_partial_differential_equation">elliptic partial differential equations</a> such as the <a href="https://en.wikipedia.org/wiki/Poisson%27s_equation">Poisson
equation</a> for self-gravity, and the <a href="https://en.wikipedia.org/wiki/Diffusion_equation">diffusion equation</a>. BoxLib therefore
includes <a href="https://en.wikipedia.org/wiki/Multigrid_method">geometric multigrid solvers</a> for solving problems which use both
cell-centered and nodal data. For this project, we have focused on the
cell-centered solver due to its relative simplicity compared to the nodal
solver.</p>
<p>Geometric multigrid is an iterative method for solving linear problems which
contains roughly 4 steps:</p>
<ul>
<li>relaxation</li>
<li>restriction</li>
<li>prolongation</li>
<li>coarse-grid linear solve (either approximate or exact)</li>
</ul>
<p>Although here we will not discuss the details of the geometric multigrid
method, we summarize each of these steps below as they pertain to computational
algorithms. Although these steps are algorithmically unique, we note that all
of them feature low arithmetic intensity and are thus sensitive to cache and
memory bandwidth.</p>
<h2 id="relaxation">Relaxation<a class="headerlink" href="#relaxation" title="Permanent link">&para;</a></h2>
<p>A relaxation consists of one or more iterations of an approximate solution to
the system of linear equations. In geometric multigrid, common algorithms used
here include Jacobi and Gauss-Seidel. By default, the BoxLib solver uses a
variation on Gauss-Seidel called Gauss-Seidel red-black ("GSRB"). GSRB deviates
from the original <a href="https://en.wikipedia.org/wiki/Gauss–Seidel_method">Gauss-Seidel method</a> by exploiting a symmetry in the data
dependence among matrix elements, such that an update sweep of all matrix
elements follows a stride-2 pattern rather than stride-1. (This property
manifests in the innermost loop of the kernel shown below).</p>
<div class="codehilite"><pre><span></span><span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
     <span class="n">ioff</span> <span class="o">=</span> <span class="nb">MOD</span><span class="p">(</span><span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">redblack</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
     <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ioff</span><span class="p">,</span><span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span>
        <span class="nb">gamma</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
              <span class="o">+</span>   <span class="n">dhx</span><span class="o">*</span><span class="p">(</span><span class="n">bX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">bX</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">&amp;</span>
              <span class="o">+</span>   <span class="n">dhy</span><span class="o">*</span><span class="p">(</span><span class="n">bY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">bY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">&amp;</span>
              <span class="o">+</span>   <span class="n">dhz</span><span class="o">*</span><span class="p">(</span><span class="n">bZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">bZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">g_m_d</span> <span class="o">=</span> <span class="nb">gamma</span> <span class="p">&amp;</span>
              <span class="o">-</span> <span class="p">(</span><span class="n">dhx</span><span class="o">*</span><span class="p">(</span><span class="n">bX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf0</span> <span class="o">+</span> <span class="n">bX</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf3</span><span class="p">)</span> <span class="p">&amp;</span>
              <span class="o">+</span>  <span class="n">dhy</span><span class="o">*</span><span class="p">(</span><span class="n">bY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf1</span> <span class="o">+</span> <span class="n">bY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf4</span><span class="p">)</span> <span class="p">&amp;</span>
              <span class="o">+</span>  <span class="n">dhz</span><span class="o">*</span><span class="p">(</span><span class="n">bZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cf2</span> <span class="o">+</span> <span class="n">bZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cf5</span><span class="p">))</span> <span class="p">&amp;</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="n">dhx</span><span class="o">*</span><span class="p">(</span> <span class="n">bX</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
            <span class="o">+</span>       <span class="n">bX</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
            <span class="o">+</span> <span class="n">dhy</span><span class="o">*</span><span class="p">(</span> <span class="n">bY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
            <span class="o">+</span>       <span class="n">bY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
            <span class="o">+</span> <span class="n">dhz</span><span class="o">*</span><span class="p">(</span> <span class="n">bZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
            <span class="o">+</span>       <span class="n">bZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>

        <span class="n">res</span> <span class="o">=</span>  <span class="n">rhs</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">gamma</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">rho</span><span class="p">)</span>
        <span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">phi</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">omega</span><span class="o">/</span><span class="n">g_m_d</span> <span class="o">*</span> <span class="n">res</span>
     <span class="k">end do</span>
<span class="k">  end do</span>
<span class="k">end do</span>
</pre></div>

<p>The algorithm above uses a 7-point cell-centered discretization of the 3-D
variable-coefficient Helmholtz operator. The diffusion operator is one type of
Helmholtz operator; the Laplace operator, which appears in the Poisson equation
for self-gravity, is a simplified version, with constant coefficients.</p>
<p>The GSRB method for a 7-point discretization of the Helmholtz operator exhibits
a low arithmetic intensity, requiring several non-contiguous loads from memory
to evaluate the operator.</p>
<p>The relaxation step and the coarse grid solve (discussed below) often feature
similar computational and data access patterns, because both are effectively
doing the same thing - solving a linear system. The primary difference between
them is that the relaxation method applies the iterative kernel only a handful
of times, whereas the coarse grid solve often iterates all the way to
convergence.</p>
<h2 id="restriction">Restriction<a class="headerlink" href="#restriction" title="Permanent link">&para;</a></h2>
<p>During a restriction, the value of a field on a fine grid is approximated on a
coarser grid. This is typically done by averaging values of the field on fine
grid points onto the corresponding grid points on the coarse grid. In BoxLib,
the algorithm is the following:</p>
<div class="codehilite"><pre><span></span><span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="n">k2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span>
  <span class="n">k2p1</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">j2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">j</span>
    <span class="n">j2p1</span> <span class="o">=</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">i2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span>
      <span class="n">i2p1</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="p">(</span>
<span class="err">$</span>                 <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">)</span>
<span class="err">$</span>                 <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">)</span>
<span class="err">$</span>                 <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">)</span>
<span class="err">$</span>                 <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">)</span>
<span class="err">$</span>                 <span class="p">)</span><span class="o">*</span><span class="n">eighth</span>
    <span class="k">end do</span>
<span class="k">  end do</span>
<span class="k">end do</span>
</pre></div>

<p>where <code>f</code> is the field on the fine grid and <code>c</code> is the field on the coarse
grid. (This multigrid solver always coarsens grids by factors of two in each
dimension.) For each evaluation of a coarse grid point, the algorithm must load
8 values from the fine grid. However, there is significant memory locality in
this algorithm, as many of the fine grid points for coarse grid point
<code>c(i,j,k)</code> also contribute to the point <code>c(i+1,j,k)</code>.</p>
<h2 id="prolongation">Prolongation<a class="headerlink" href="#prolongation" title="Permanent link">&para;</a></h2>
<p>Prolongation (also called interpolation) is the opposite of restriction: one
approximates the value of a field on a coarse grid on a finer grid. The
prolongation kernel in the BoxLib solver is as follows:
<div class="codehilite"><pre><span></span><span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="n">k2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span>
  <span class="n">k2p1</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">j2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">j</span>
    <span class="n">j2p1</span> <span class="o">=</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">lo</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">hi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">i2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span>
      <span class="n">i2p1</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="mi">1</span>

      <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">)</span>
      <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2</span>  <span class="p">)</span>
      <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">)</span>
      <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2</span>  <span class="p">)</span>
      <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">)</span>
      <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2p1</span><span class="p">,</span><span class="n">k2p1</span><span class="p">)</span>
      <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2p1</span><span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">)</span>
      <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">i2</span>  <span class="p">,</span><span class="n">j2</span>  <span class="p">,</span><span class="n">k2p1</span><span class="p">)</span>

    <span class="k">end do</span>
<span class="k">  end do</span>
<span class="k">end do</span>
</pre></div></p>
<p>In 3-D, the same value on the coarse grid contributes equally to eight
neighboring points in the fine grid. (The symmetry arises from the constraint
in the solver that the cells must be cubic.)</p>
<h2 id="exact-linear-solve">Exact linear solve<a class="headerlink" href="#exact-linear-solve" title="Permanent link">&para;</a></h2>
<p>The multigrid solver in BoxLib recursively coarsens grids until the grid
reaches a sufficiently small size, often <span>\(2^3\)</span> if the problem domain is cubic.
On the coarsest grid, the solver then solves the linear system exactly, before
propagating the solution back up to finer grids. The solution algorithm chosen
for this step is rarely influential on the overall performance of the multigrid
algorithm, because the problem size at the coarsest grid is so small. In
BoxLib, the default coarse grid solver algorithm is <a href="https://en.wikipedia.org/wiki/Biconjugate_gradient_stabilized_method">BiCGSTAB</a>, a variation on
the conjugate-gradient iterative method.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../code_structure/" title="Code Structure" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Code Structure
              </span>
            </div>
          </a>
        
        
          <a href="../kokkos_implementation/" title="Kokkos" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Kokkos
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>