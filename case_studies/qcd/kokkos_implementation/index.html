
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>Kokkos - Performance Portability</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="green" data-md-color-accent="yellow">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Performance Portability" class="md-logo md-header-nav__button">
            <img src="../../../images/oos.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  QCD
                </span>
              
                <span class="md-header-nav__parent">
                  Implementations
                </span>
              
            
            Kokkos
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../../../images/oos.png">
      </i>
    
    Performance Portability
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Office of Science Facilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Office of Science Facilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../facilities/comparison/" title="Comparison" class="md-nav__link">
      Comparison
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Performance Portability
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Performance Portability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/definition/" title="Definition" class="md-nav__link">
      Definition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Measurements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Measurements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/" title="Measurement Techniques" class="md-nav__link">
      Measurement Techniques
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/knl/" title="Measuring Roofline Data on KNL" class="md-nav__link">
      Measuring Roofline Data on KNL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/measurements/gpu/" title="Measuring Roofline Data on GPUs" class="md-nav__link">
      Measuring Roofline Data on GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Approaches
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Approaches
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/libraries/" title="Libraries" class="md-nav__link">
      Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-2" type="checkbox" id="nav-3-3-2">
    
    <label class="md-nav__link" for="nav-3-3-2">
      Directives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-2">
        Directives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openacc/" title="OpenACC" class="md-nav__link">
      OpenACC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/directives/openmp/" title="OpenMP" class="md-nav__link">
      OpenMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3-3" type="checkbox" id="nav-3-3-3">
    
    <label class="md-nav__link" for="nav-3-3-3">
      Frameworks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-3-3">
        Frameworks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/kokkos/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/frameworks/raja/" title="RAJA" class="md-nav__link">
      RAJA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/dsl/" title="DSL" class="md-nav__link">
      DSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../perfport/summary/" title="Summary" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4" checked>
    
    <label class="md-nav__link" for="nav-3-4">
      Case Studies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Case Studies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1" type="checkbox" id="nav-3-4-1">
    
    <label class="md-nav__link" for="nav-3-4-1">
      BoxLib
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-1">
        BoxLib
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../amr/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../amr/parallelism/" title="Parallelism" class="md-nav__link">
      Parallelism
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../amr/code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../amr/multigrid/" title="Geometric Multigrid" class="md-nav__link">
      Geometric Multigrid
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-1-5" type="checkbox" id="nav-3-4-1-5">
    
    <label class="md-nav__link" for="nav-3-4-1-5">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-1-5">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../amr/kokkos_implementation/" title="Kokkos" class="md-nav__link">
      Kokkos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../gw/" title="GW Kernels" class="md-nav__link">
      GW Kernels
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3" checked>
    
    <label class="md-nav__link" for="nav-3-4-3">
      QCD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        QCD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_structure/" title="Code Structure" class="md-nav__link">
      Code Structure
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3-3" type="checkbox" id="nav-3-4-3-3" checked>
    
    <label class="md-nav__link" for="nav-3-4-3-3">
      Implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-3-4-3-3">
        Implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Kokkos
      </label>
    
    <a href="./" title="Kokkos" class="md-nav__link md-nav__link--active">
      Kokkos
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#complex-numbers-and-c" title="Complex Numbers and C++" class="md-nav__link">
    Complex Numbers and C++
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ensuring-vectorization" title="Ensuring Vectorization" class="md-nav__link">
    Ensuring Vectorization
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specialization-for-cpu" title="Specialization for CPU" class="md-nav__link">
    Specialization for CPU
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../nek/" title="NekBone" class="md-nav__link">
      NekBone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../md/" title="MD" class="md-nav__link">
      MD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../resources/" title="Other Resources" class="md-nav__link">
      Other Resources
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../demo/demo/" title="Demo" class="md-nav__link">
      Demo
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#complex-numbers-and-c" title="Complex Numbers and C++" class="md-nav__link">
    Complex Numbers and C++
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ensuring-vectorization" title="Ensuring Vectorization" class="md-nav__link">
    Ensuring Vectorization
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#specialization-for-cpu" title="Specialization for CPU" class="md-nav__link">
    Specialization for CPU
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="kokkos-implementation">Kokkos Implementation<a class="headerlink" href="#kokkos-implementation" title="Permanent link">&para;</a></h1>
<p>In this implementation, we will use the <code>Kokkos::View</code> type as our data container. Therefore, the <a href="../code_structure/#Data_Primitives">spinor and gaugefield classes</a> become</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ST</span><span class="p">,</span><span class="kt">int</span> <span class="n">nspin</span><span class="o">&gt;</span> 
<span class="k">class</span> <span class="nc">CBSpinor</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span> 
    <span class="p">...</span>
<span class="k">private</span><span class="o">:</span>
    <span class="c1">// dims are: site, color, spin</span>
    <span class="n">Kokkos</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="n">ST</span><span class="o">*</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">nspin</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">GT</span><span class="o">&gt;</span> 
<span class="k">class</span> <span class="nc">CBGaugeField</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="p">...</span>
<span class="k">private</span><span class="o">:</span>
    <span class="c1">// dims are: site, direction, color, color</span>
    <span class="n">gauge_container</span><span class="o">&lt;</span><span class="n">GT</span><span class="o">*</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>Note that the site index dimension is a runtime dimension (denoted by <code>*</code>) whereas the other dimensions - color and spin - are fixed (denoted by <code>[const]</code>). Explicitly stating this is recommended by the kokkos developers because it should help the compiler to optimize the code. </p>
<p>In the <a href="../code_structure/#wilson_operator">Wilsion operator class</a>, all what we need to do is to insert the kokkos parallel dispatcher. Hence it becomes</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">GT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ST</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TST</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">Dslash</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">(</span><span class="k">const</span> <span class="n">CBSpinor</span><span class="o">&lt;</span><span class="n">ST</span><span class="p">,</span><span class="mi">4</span><span class="o">&gt;&amp;</span> <span class="n">s_in</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">CBGaugeField</span><span class="o">&lt;</span><span class="n">GT</span><span class="o">&gt;&amp;</span> <span class="n">g_in</span><span class="p">,</span>
                  <span class="n">CBSpinor</span><span class="o">&lt;</span><span class="n">ST</span><span class="p">,</span><span class="mi">4</span><span class="o">&gt;&amp;</span> <span class="n">s_out</span><span class="p">,</span>
                  <span class="kt">int</span> <span class="n">plus_minus</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="c1">// Threaded loop over sites</span>
        <span class="n">Kokkos</span><span class="o">::</span><span class="n">parallel_for</span><span class="p">(</span><span class="n">num_sites</span><span class="p">,</span> <span class="n">KOKKOS_LAMBDA</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>

<h2 id="complex-numbers-and-c">Complex Numbers and C++<a class="headerlink" href="#complex-numbers-and-c" title="Permanent link">&para;</a></h2>
<p>We want to emphasize a subtle performance pitfall when it comes to complex numbers in C++. The language standards inhibit the compiler to efficiently optimize operations such as </p>
<div class="codehilite"><pre><span></span><span class="n">c</span> <span class="o">+=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
</pre></div>

<p>when <code>a</code>, <code>b</code> and <code>c</code> are complex numbers. Naively, this expression could be expanded into </p>
<div class="codehilite"><pre><span></span><span class="n">re</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+=</span> <span class="n">re</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">re</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">im</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">im</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">im</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+=</span> <span class="n">re</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">im</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">im</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">re</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>

<p>where <code>re(.), im(.)</code> denote the real and imaginary part of its argument respectively. This expresson can nicely be packed into a total of four FMA operations per line. However, in the simplified form above which is usually used in context of operator overloading, the compier would have to evaluate the right hand side first and then sum the result into <code>c</code>. This is much less efficient since in that case, only two FMA as well as two multiplications and additions could be used. One has to keep that in mind when doing complex algebra in C++. In many cases it is better to inline code and avoid otherwise useful operator overloading techniques for complex algebra.</p>
<h2 id="ensuring-vectorization">Ensuring Vectorization<a class="headerlink" href="#ensuring-vectorization" title="Permanent link">&para;</a></h2>
<p>Vectorization in Kokkos is achieved by a two-level <a href="../../perfport/models/kokkos.md#vectorization">nested parallelism</a>, where the outer loop spawns threads (pthreads, OpenMP-threads) on the CPU and threads in CUDA-block y-direction on the GPU. The inner loop then applies vectorization pragmas on the CPU or spwans threads in x-direction on the GPU. This is where we have to show some awareness of architectural differences: the spinor work type <code>TST</code> needs to be a scalar type on the GPU and a vector type on the CPU. Hence we declare the following types on GPU and CPU respectively</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span><span class="n">N</span><span class="o">&gt;</span> 
<span class="k">struct</span> <span class="n">CPUSIMDComplex</span> <span class="p">{</span>
    <span class="n">Kokkos</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_data</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
    <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">lane</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">lane</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span><span class="n">N</span><span class="o">&gt;</span> 
<span class="k">struct</span> <span class="n">GPUSIMDComplex</span> <span class="p">{</span>
    <span class="n">Kokkos</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_data</span><span class="p">;</span>
    <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">lane</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">_data</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<p>The latter construct might look confusing first, because the access operator ignores the <code>lane</code> parameter. This is because the SIMT threading is implicit in Kokkos and each SIMT thread is holding it's own data <code>_data</code>. Nevertheless, it is useful to implement the access operator that way to preserve a common, portable style throughout the rest of the code.</p>
<h3 id="specialization-for-cpu">Specialization for CPU<a class="headerlink" href="#specialization-for-cpu" title="Permanent link">&para;</a></h3>
<p>In theory, these two types are sufficient for ensuring proper vectorization on both CPU and GPU. In our experiments however, we found that neither Intel nor GNU compiler could vectorize the complex operations inside the spinors properly, leading to a very poor performance. This is not a problem of Kokkos itself, it is merely the inability of compilers to efficiently vectorized complex algebra.
We therefore provided a template  specialization for the <code>CPUSIMDComplex</code> datatype which we implemented by explicitly using AVX512 intrinsics. For example, the datatype then becomes</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="k">struct</span> <span class="n">CPUSIMDComplex</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">8</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">explicit</span> <span class="n">CPUSIMDComplex</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{}</span>

    <span class="k">union</span> <span class="p">{</span>
        <span class="n">Kokkos</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">_data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
        <span class="n">__m512</span> <span class="n">_vdata</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>

<p>and, for example, the vectorized multiplication of two complex numbers</p>
<div class="codehilite"><pre><span></span><span class="k">template</span><span class="o">&lt;&gt;</span> <span class="n">KOKKOS_FORCEINLINE_FUNCTION</span>
<span class="kt">void</span> <span class="n">ComplexCMadd</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">CPUSIMDComplex</span><span class="p">,</span><span class="n">CPUSIMDComplex</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CPUSIMDComplex</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">8</span><span class="o">&gt;&amp;</span> <span class="n">res</span><span class="p">,</span>
                                                         <span class="k">const</span> <span class="n">Kokkos</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">a</span><span class="p">,</span>
                                                         <span class="k">const</span> <span class="n">CPUSIMDComplex</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">8</span><span class="o">&gt;&amp;</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__m512</span> <span class="n">avec_re</span> <span class="o">=</span> <span class="n">_mm512_set1_ps</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">real</span><span class="p">()</span> <span class="p">);</span>
  <span class="n">__m512</span> <span class="n">avec_im</span> <span class="o">=</span> <span class="n">_mm512_set1_ps</span><span class="p">(</span> <span class="n">a</span><span class="p">.</span><span class="n">imag</span><span class="p">()</span> <span class="p">);</span>

  <span class="n">__m512</span> <span class="n">sgnvec</span> <span class="o">=</span> <span class="n">_mm512_set_ps</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">__m512</span> <span class="n">perm_b</span> <span class="o">=</span> <span class="n">_mm512_mul_ps</span><span class="p">(</span><span class="n">sgnvec</span><span class="p">,</span><span class="n">_mm512_shuffle_ps</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">_vdata</span><span class="p">,</span><span class="n">b</span><span class="p">.</span><span class="n">_vdata</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">));</span>

  <span class="n">res</span><span class="p">.</span><span class="n">_vdata</span> <span class="o">=</span> <span class="n">_mm512_fmadd_ps</span><span class="p">(</span> <span class="n">avec_re</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">_vdata</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">_vdata</span><span class="p">);</span>
  <span class="n">res</span><span class="p">.</span><span class="n">_vdata</span> <span class="o">=</span> <span class="n">_mm512_fmadd_ps</span><span class="p">(</span> <span class="n">avec_im</span><span class="p">,</span><span class="n">perm_b</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">_vdata</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Note that we use inter-lane shuffle operations to swap complex and imaginary parts and use vectorized FMA operations. We suspect that compilers are unable to detect the opportunity of performing those inter-lane shuffles and thus fail to properly vectorize the code.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../code_structure/" title="Code Structure" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Code Structure
              </span>
            </div>
          </a>
        
        
          <a href="../../nek/" title="NekBone" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                NekBone
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>